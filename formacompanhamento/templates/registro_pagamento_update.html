{% extends 'base.html' %}
{% load widget_tweaks %}

{% block content %}
{% include "components/_header.html" %}
<!-- Inclua o CSS do Mapbox -->
<link href="https://api.mapbox.com/mapbox-gl-js/v2.12.0/mapbox-gl.css" rel="stylesheet" />

<style>
  #map { height: 500px; margin-top: 20px; }
  .container { max-width: 80%; }
  .card { width: 100%; }
  form input, form select, form textarea { width: 100% !important; }
  .error-message { color: #dc3545; font-size: 0.875rem; margin-top: 0.25rem; }
  .is-invalid { border-color: #dc3545; }
  .alert-danger { margin-bottom: 1rem; }
  .form-group { margin-bottom: 1rem; }
</style>

<div class="container mt-4">
  <h3 class="text-white">
    {% if form.instance.pk %}Editar Pagamento{% else %}Novo Acionamento{% endif %}
  </h3>

  {% if form.errors %}
  <div class="alert alert-danger">
    <h4 class="alert-heading">Por favor, corrija os seguintes erros:</h4>
    <ul class="mb-0">
      {% for field, errors in form.errors.items %}
        {% for error in errors %}
          <li><strong>{{ field|title }}:</strong> {{ error }}</li>
        {% endfor %}
      {% endfor %}
    </ul>
  </div>
  {% endif %}

  <div class="card mb-4">
    <div class="card-body">
      <form method="post" action="{% url 'formacompanhamento:registro_pagamento_update' form.instance.pk %}" enctype="multipart/form-data">
        {% csrf_token %}
        <!-- Copiado do template de criação para garantir todos os campos e funcionalidades -->
        <!-- CAMPOS CLIENTE E PRESTADOR -->
        <h4 class="mt-2">Tipo de Serviço</h4>
        <div class="row mb-3">
          <div class="col-md-4 form-group">
            <label for="id_tipo_servicos" class="form-label">Tipo de Serviço</label>
            {{ form.tipo_servicos|add_class:"form-control"|add_error_class:"is-invalid" }}
            {% if form.tipo_servicos.errors %}
              <div class="error-message">{{ form.tipo_servicos.errors.0 }}</div>
            {% endif %}
          </div></div>
        <h4 class="mt-2">Dados do Cliente</h4>
        <div class="row mb-3">
          <div class="col-md-4 form-group">
            <label for="id_cliente" class="form-label">Cliente</label>
            {{ form.cliente|add_class:"form-control"|add_error_class:"is-invalid" }}
            {% if form.cliente.errors %}
              <div class="error-message">{{ form.cliente.errors.0 }}</div>
            {% endif %}
          </div>
          <div class="col-md-4">
            <label for="id_protocolo" class="form-label">Protocolo</label>
            {{ form.protocolo }}
          </div>
          <div class="col-md-4">
            <label for="id_endereco" class="form-label">Endereço</label>
            {{ form.endereco }}
            <button type="button" class="btn btn-info mt-2" onclick="openMap()">Ver Mapa</button>
          </div>
        </div>
        <div><hr><h3>Dados do Veiculo</h3>
<div class="row mb-3">
  <div class="col-md-3">
    <label for="id_modelo" class="form-label">Marca / Modelo</label>
    {{ form.modelo }}
  </div>
  <div class="col-md-3">
    <label for="id_ano" class="form-label">Ano Fabricação / Modelo</label>
    {{ form.ano }}
  </div>
  <div class="col-md-3">
    <label for="id_cor" class="form-label">Cor</label>
    {{ form.cor }}
  </div>
</div>
<button type="button" id="btnAdicionarPlaca" class="btn btn-secondary mb-3">Adicionar Placa</button>
<div class="row mb-3">
  <div class="col-md-4 placa-dinamica" id="placa1" style="display: none;">
    <label for="id_placas1" class="form-label">Placa1</label>
    {{ form.placas1 }}
  </div>
  <div class="col-md-4 placa-dinamica" id="placa2" style="display: none;">
    <label for="id_placas2" class="form-label">Placa2</label>
    {{ form.placas2 }}
  </div>
  <div class="col-md-4 placa-dinamica" id="placa3" style="display: none;">
    <label for="id_placas3" class="form-label">Placa3</label>
    {{ form.placas3 }}
  </div>
</div>
<hr>
<h4 class="text-white">Dados do Acionamento</h4>
<div class="row mb-3">
  <div class="col-md-5">
    <label for="id_solicitante" class="form-label">Solicitante</label>
    {{ form.solicitante }}
  </div>
  <div class="col-md-2">
    <label for="id_tipo_contato" class="form-label">Tipo de Contato</label>
    {{ form.tipo_contato }}
  </div>
  <div class="col-md-3">
    <label for="id_motivo" class="form-label">Motivo</label>
    <div class="input-group">
      {{ form.motivo|add_class:"form-control border-danger" }}
    </div>
  </div>
  <div class="col-md-2">
    <label for="id_quantidade_agentes" class="form-label">Quantidade de Agentes</label>
    {{ form.quantidade_agentes }}
  </div>
</div>
<div class="row mb-3">
  <div class="col-md-2">
    <label for="id_prestador" class="form-label">Prestador</label>
    {{ form.prestador|add_class:"form-control"|add_error_class:"is-invalid" }}
    {% if form.prestador.errors %}
      <div class="error-message">{{ form.prestador.errors.0 }}</div>
    {% endif %}
  </div>
  <div class="col-md-2">
    <label for="id_acionamento" class="form-label">Valor de Acionamento</label>
    {{ form.acionamento }}
  </div>
  <div class="col-md-2">
    <label for="id_franquia_hora" class="form-label">Franquia de Horas</label>
    {{ form.franquia_hora }}
  </div>
  <div class="col-md-2">
    <label for="id_km_franquia" class="form-label">Franquia de KM</label>
    {{ form.km_franquia }}
  </div>
  <div class="col-md-2">
    <label for="id_valor_hora_excedente" class="form-label">Valor de Hora Excedente</label>
    {{ form.valor_hora_excedente }}
  </div>
  <div class="col-md-2">
    <label for="id_valor_km_excedente" class="form-label">Valor de KM Excedente</label>
    {{ form.valor_km_excedente }}
  </div>
</div>
<hr>
<h4 class="mt-4">Dados da Operação</h4>
<div class="row mb-3">
  <div class="col-md-3">
    <label for="id_data_hora_inicial" class="form-label">Início de Operação</label>
    <div class="input-group">
      {{ form.data_hora_inicial }}
      <button type="button" class="btn btn-primary" id="btn_inicial" onclick="registrarDataHora('id_data_hora_inicial','btn_inicial')">Registrar</button>
    </div>
  </div>
  <div class="col-md-1">
    <label for="id_sla" class="form-label">SLA</label>
    {{ form.sla }}
  </div>
  <div class="col-md-2">
    <label for="id_previsa_chegada" class="form-label">Previsão de Chegada</label>
    {{ form.previsa_chegada }}
  </div>
  <div class="col-md-3">
    <label for="id_data_hora_chegada" class="form-label">Data e Hora (Chegada)</label>
    <div class="input-group">
      {{ form.data_hora_chegada }}
      <button type="button" class="btn btn-primary" id="btn_chegada" onclick="registrarDataHora('id_data_hora_chegada','btn_chegada')">Registrar</button>
    </div>
  </div>
  <div class="col-md-3">
    <label for="id_data_hora_final" class="form-label">Final de Operação</label>
    <div class="input-group">
      {{ form.data_hora_final }}
      <button type="button" class="btn btn-primary" id="btn_final" onclick="registrarDataHora('id_data_hora_final','btn_final')">Registrar</button>
    </div>
  </div>
</div>
<div class="row mb-3">
  <div class="col-md-2">
    <label for="id_hora_total" class="form-label">Hora Total</label>
    {{ form.hora_total }}
  </div>
  <div class="col-md-2">
    <label for="id_km_inicial" class="form-label">Km Inicial</label>
    {{ form.km_inicial }}
  </div>
  <div class="col-md-2">
    <label for="id_km_final" class="form-label">Km Final</label>
    {{ form.km_final }}
  </div>
  <div class="col-md-2">
    <label for="id_km_total" class="form-label">KM Total</label>
    {{ form.km_total }}
  </div>
  <div class="col-md-2">
    <label for="id_km_excedente" class="form-label">KM Excedente</label>
    {{ form.km_excedente }}
  </div>
  <div class="col-md-2">
    <label for="id_hora_excedente" class="form-label">Hora Excedente</label>
    {{ form.hora_excedente }}
  </div>
</div>
<hr>
<button type="button" id="btnAdicionarAgente" class="btn btn-secondary mb-3">Adicionar Agente</button>
<h5>Agentes Adicionais</h5>
<div id="agentes-container">
  <!-- Blocos de agentes adicionais copiados do template de criação -->
  <div class="agente-dinamico" id="agente1" style="display: none;">
    <div class="row mb-3">
      <div class="col-md-3">
        <label for="id_prestador1" class="form-label">Prestador</label>
        {{ form.prestador1|add_class:"prestador-select" }}
      </div>
      <div class="col-md-1">
        <label for="id_acionamento1" class="form-label">Acionamento</label>
        {{ form.acionamento1 }}
      </div>
      <div class="col-md-2">
        <label for="id_km_franquia1" class="form-label">Franquia de KM</label>
        {{ form.km_franquia1 }}
      </div>
      <div class="col-md-2">
        <label for="id_franquia_hora1" class="form-label">Franquia Hora</label>
        {{ form.franquia_hora1 }}
      </div>
      <div class="col-md-2">
        <label for="id_valor_hora_excedente1" class="form-label">Valor Hora Excedente</label>
        {{ form.valor_hora_excedente1 }}
      </div>
      <div class="col-md-2">
        <label for="id_hora_excedente1" class="form-label">Hora Excedente</label>
        {{ form.hora_excedente1 }}
      </div>
    </div>
    <div class="row mb-3">
      <div class="col-md-4">
        <label for="id_data_hora_inicial1" class="form-label">Início de Operação 1</label>
        <div class="input-group">
          {{ form.data_hora_inicial1 }}
          <button type="button" class="btn btn-primary" id="btn_inicial1" onclick="registrarDataHora('id_data_hora_inicial1','btn_inicial1')">Registrar</button>
        </div>
      </div>
      <div class="col-md-4">
        <label for="id_data_hora_chegada1" class="form-label">Data e Hora (Chegada) 1</label>
        <div class="input-group">
          {{ form.data_hora_chegada1 }}
          <button type="button" class="btn btn-primary" id="btn_chegada1" onclick="registrarDataHora('id_data_hora_chegada1','btn_chegada1')">Registrar</button>
        </div>
      </div>
      <div class="col-md-4">
        <label for="id_data_hora_final1" class="form-label">Final de Operação 1</label>
        <div class="input-group">
          {{ form.data_hora_final1 }}
          <button type="button" class="btn btn-primary" id="btn_final1" onclick="registrarDataHora('id_data_hora_final1','btn_final1')">Registrar</button>
        </div>
      </div>
    </div>
    <div class="row mb-3">
      <div class="col-md-4">
        <label for="id_km_inicial1" class="form-label">Km Inicial 1</label>
        {{ form.km_inicial1 }}
      </div>
      <div class="col-md-4">
        <label for="id_km_final1" class="form-label">Km Final 1</label>
        {{ form.km_final1 }}
      </div>
      <div class="col-md-4">
        <label for="id_km_total1" class="form-label">KM Total 1</label>
        {{ form.km_total1 }}
      </div>
    </div>
    <div class="row mb-3">
      <div class="col-md-2">
        <label for="id_km_excedente1" class="form-label">KM Excedente 1</label>
        {{ form.km_excedente1 }}
      </div>
      <div class="col-md-2">
        <label for="id_valor_total_km_excedente1" class="form-label">Valor KM Excedente 1</label>
        {{ form.valor_km_excedente1 }}
      </div>
      <div class="col-md-2">
        <label for="id_hora_total1" class="form-label">Hora Total 1</label>
        <input type="text" name="hora_total1" id="id_hora_total1" class="form-control" placeholder="Hora Total" readonly>
      </div>
      <div class="col-md-2">
        <label for="id_motivo1" class="form-label">Motivo</label>
        <div class="input-group">
          {{ form.motivo1|add_class:"form-control border-danger" }}
        </div>
      </div>
    </div>
  </div>
  <!-- Repita para agente2 e agente3 igual ao template de criação -->
  <div class="agente-dinamico" id="agente2" style="display: none;">
    <hr>
    <div class="row mb-3">
      <div class="col-md-3">
        <label for="id_prestador2" class="form-label">Prestador</label>
        {{ form.prestador2|add_class:"prestador-select" }}
      </div>
      <div class="col-md-1">
        <label for="id_acionamento2" class="form-label">Acionamento</label>
        {{ form.acionamento2 }}
      </div>
      <div class="col-md-2">
        <label for="id_km_franquia2" class="form-label">Franquia de KM</label>
        {{ form.km_franquia2 }}
      </div>
      <div class="col-md-2">
        <label for="id_franquia_hora2" class="form-label">Franquia Hora</label>
        {{ form.franquia_hora2 }}
      </div>
      <div class="col-md-2">
        <label for="id_valor_hora_excedente2" class="form-label">Valor Hora Excedente</label>
        {{ form.valor_hora_excedente2 }}
      </div>
      <div class="col-md-2">
        <label for="id_hora_excedente2" class="form-label">Hora Excedente</label>
        {{ form.hora_excedente2 }}
      </div>
    </div>
    <div class="row mb-3">
      <div class="col-md-4">
        <label for="id_data_hora_inicial2" class="form-label">Início de Operação 2</label>
        <div class="input-group">
          {{ form.data_hora_inicial2 }}
          <button type="button" class="btn btn-primary" id="btn_inicial2" onclick="registrarDataHora('id_data_hora_inicial2','btn_inicial2')">Registrar</button>
        </div>
      </div>
      <div class="col-md-4">
        <label for="id_data_hora_chegada2" class="form-label">Data e Hora (Chegada) 2</label>
        <div class="input-group">
          {{ form.data_hora_chegada2 }}
          <button type="button" class="btn btn-primary" id="btn_chegada2" onclick="registrarDataHora('id_data_hora_chegada2','btn_chegada2')">Registrar</button>
        </div>
      </div>
      <div class="col-md-4">
        <label for="id_data_hora_final2" class="form-label">Final de Operação 2</label>
        <div class="input-group">
          {{ form.data_hora_final2 }}
          <button type="button" class="btn btn-primary" id="btn_final2" onclick="registrarDataHora('id_data_hora_final2','btn_final2')">Registrar</button>
        </div>
      </div>
    </div>
    <div class="row mb-3">
      <div class="col-md-4">
        <label for="id_km_inicial2" class="form-label">Km Inicial 2</label>
        {{ form.km_inicial2 }}
      </div>
      <div class="col-md-4">
        <label for="id_km_final2" class="form-label">Km Final 2</label>
        {{ form.km_final2 }}
      </div>
      <div class="col-md-4">
        <label for="id_km_total2" class="form-label">KM Total 2</label>
        {{ form.km_total2 }}
      </div>
    </div>
    <div class="row mb-3">
      <div class="col-md-3">
        <label for="id_km_excedente2" class="form-label">KM Excedente 2</label>
        {{ form.km_excedente2 }}
      </div>
      <div class="col-md-3">
        <label for="id_valor_total_km_excedente2" class="form-label">Valor KM Excedente 2</label>
        {{ form.valor_km_excedente2 }}
      </div>
      <div class="col-md-3">
        <label for="id_hora_total2" class="form-label">Hora Total 2</label>
        <input type="text" name="hora_total2" id="id_hora_total2" class="form-control" placeholder="Hora Total" readonly>
      </div>
      <div class="col-md-3">
        <label for="id_motivo2" class="form-label">Motivo</label>
        <div class="input-group">
          {{ form.motivo2|add_class:"form-control border-danger" }}
        </div>
      </div>
    </div>
  </div>
  <div class="agente-dinamico" id="agente3" style="display: none;">
    <hr>
    <div class="row mb-3">
      <div class="col-md-3">
        <label for="id_prestador3" class="form-label">Prestador</label>
        {{ form.prestador3|add_class:"prestador-select" }}
      </div>
      <div class="col-md-1">
        <label for="id_acionamento3" class="form-label">Acionamento</label>
        {{ form.acionamento3 }}
      </div>
      <div class="col-md-2">
        <label for="id_km_franquia3" class="form-label">Franquia de KM</label>
        {{ form.km_franquia3 }}
      </div>
      <div class="col-md-2">
        <label for="id_franquia_hora3" class="form-label">Franquia Hora</label>
        {{ form.franquia_hora3 }}
      </div>
      <div class="col-md-2">
        <label for="id_valor_hora_excedente3" class="form-label">Valor Hora Excedente</label>
        {{ form.valor_hora_excedente3 }}
      </div>
      <div class="col-md-2">
        <label for="id_hora_excedente3" class="form-label">Hora Excedente</label>
        {{ form.hora_excedente3 }}
      </div>
    </div>
    <div class="row mb-3">
      <div class="col-md-4">
        <label for="id_data_hora_inicial3" class="form-label">Início de Operação 3</label>
        <div class="input-group">
          {{ form.data_hora_inicial3 }}
          <button type="button" class="btn btn-primary" id="btn_inicial3" onclick="registrarDataHora('id_data_hora_inicial3','btn_inicial3')">Registrar</button>
        </div>
      </div>
      <div class="col-md-4">
        <label for="id_data_hora_chegada3" class="form-label">Data e Hora (Chegada) 3</label>
        <div class="input-group">
          {{ form.data_hora_chegada3 }}
          <button type="button" class="btn btn-primary" id="btn_chegada3" onclick="registrarDataHora('id_data_hora_chegada3','btn_chegada3')">Registrar</button>
        </div>
      </div>
      <div class="col-md-4">
        <label for="id_data_hora_final3" class="form-label">Final de Operação 3</label>
        <div class="input-group">
          {{ form.data_hora_final3 }}
          <button type="button" class="btn btn-primary" id="btn_final3" onclick="registrarDataHora('id_data_hora_final3','btn_final3')">Registrar</button>
        </div>
      </div>
    </div>
    <div class="row mb-3">
      <div class="col-md-4">
        <label for="id_km_inicial3" class="form-label">Km Inicial 3</label>
        {{ form.km_inicial3 }}
      </div>
      <div class="col-md-4">
        <label for="id_km_final3" class="form-label">Km Final 3</label>
        {{ form.km_final3 }}
      </div>
      <div class="col-md-4">
        <label for="id_km_total3" class="form-label">KM Total 3</label>
        {{ form.km_total3 }}
      </div>
    </div>
    <div class="row mb-3">
      <div class="col-md-3">
        <label for="id_km_excedente3" class="form-label">KM Excedente 3</label>
        {{ form.km_excedente3 }}
      </div>
      <div class="col-md-3">
        <label for="id_valor_total_km_excedente3" class="form-label">Valor KM Excedente 3</label>
        {{ form.valor_km_excedente3 }}
      </div>
      <div class="col-md-3">
        <label for="id_hora_total3" class="form-label">Hora Total 3</label>
        <input type="text" name="hora_total3" id="id_hora_total3" class="form-control" placeholder="Hora Total" readonly>
      </div>
      <div class="col-md-3">
        <label for="id_motivo3" class="form-label">Motivo</label>
        <div class="input-group">
          {{ form.motivo3|add_class:"form-control border-danger" }}
        </div>
      </div>
    </div>
  </div>
</div>
<hr>
<div class="row mb-3">
  <div class="col-md-2">
    <label for="id_rastreador" class="form-label">Rastreador</label>
    {{ form.rastreador }}
  </div>
  <div class="col-md-2" style="display: none;" id="id_equipamento_field">
    <label for="id_id_equipamento" class="form-label">ID Equipamento</label>
    {{ form.id_equipamento }}
  </div>
  <div class="col-md-6" style="display: none;" id="ultima_posicao_field">
    <label for="id_ultima_posicao" class="form-label">Endereço da Última Posição</label>
    {{ form.ultima_posicao }}
  </div>
  <div class="col-md-2" style="display: none;" id="latlong_field">
    <label for="id_latlong" class="form-label">Latitude - Longitude</label>
    {{ form.latlong }}
  </div>
</div>
<div class="row mb-3">
  <div class="col-md-2">
    <label for="id_isca" class="form-label">Isca</label>
    {{ form.isca }}
  </div>
  <div class="col-md-2" style="display: none;" id="id_isca_field">
    <label for="id_id_isca" class="form-label">ID Equipamento</label>
    {{ form.id_isca }}
  </div>
  <div class="col-md-6" style="display: none;" id="ultima_posicao_isca_field">
    <label for="id_ultima_posicao_isca" class="form-label">Endereço da Última Posição</label>
    {{ form.ultima_posicao_isca }}
  </div>
  <div class="col-md-2" style="display: none;" id="latlong_isca_field">
    <label for="id_latlong_isca" class="form-label">Latitude - Longitude</label>
    {{ form.latlong_isca }}
  </div>
</div>
<hr>
<div class="col-md-12" id="descricao">
  <label for="{{ form.descricao.id_for_label }}" class="form-label"><h5>Descrição</h5></label>
  {{ form.descricao|add_class:"form-control" }}
</div>
<h4 class="mt-4">Imagens</h4>
<div id="imagens-groups">
  <!-- Repita os blocos de imagens igual ao template de criação -->
  <div class="row mb-3 image-group" style="display: none;">
    <div class="col-md-2">
      <label for="id_imagem1" class="form-label">Imagem 1</label>
      {{ form.imagem1 }}
    </div>
    <div class="col-md-2">
      <label for="id_imagem2" class="form-label">Imagem 2</label>
      {{ form.imagem2 }}
    </div>
    <div class="col-md-2">
      <label for="id_imagem3" class="form-label">Imagem 3</label>
      {{ form.imagem3 }}
    </div>
    <div class="col-md-2">
      <label for="id_imagem4" class="form-label">Imagem 4</label>
      {{ form.imagem4 }}
    </div>
    <div class="col-md-2">
      <label for="id_imagem5" class="form-label">Imagem 5</label>
      {{ form.imagem5 }}
    </div>
    <div class="col-md-2">
      <label for="id_imagem6" class="form-label">Imagem 6</label>
      {{ form.imagem6 }}
    </div>
  </div>
  <!-- Repita para os outros grupos de imagens igual ao template de criação -->
</div>
<button type="button" class="btn btn-primary" onclick="showMoreImages()">Adicionar fotos</button>
<div class="d-flex justify-content-between mt-4">
  <button type="submit" class="btn btn-primary">Salvar</button>
  <a href="{% url 'formacompanhamento:registro_pagamento_list' %}" class="btn btn-secondary">Cancelar e Voltar</a>
</div>
      </form>
    </div>
  </div>
</div>
{% if form.errors %}
  <div class="alert alert-danger">
    <ul>
      {% for field, errors in form.errors.items %}
        <li><strong>{{ field }}</strong>: {{ errors|join:", " }}</li>
      {% endfor %}
    </ul>
  </div>
{% endif %}
<script>
// Copie todo o JS do template de criação aqui para manter as funcionalidades
</script>
{% endblock %}
