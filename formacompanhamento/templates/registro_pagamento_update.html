{% extends 'base.html' %}
{% load widget_tweaks %}

{% block content %}
{% include "components/_header.html" %}

<style>
  .container {
    max-width: 80%; /* Adjust as needed */
  }

  .card {
    width: 100%;
  }

  form input, form select, form textarea {
    width: 100% !important;
  }

  .error-message {
    color: #dc3545;
    font-size: 0.875rem;
    margin-top: 0.25rem;
  }

  .is-invalid {
    border-color: #dc3545;
  }

  .alert-danger {
    margin-bottom: 1rem;
  }

  .form-group {
    margin-bottom: 1rem;
  }
</style>
<div class="container mt-4">
    <h3 class="text-white">Editar Pagamento</h3>

    <!-- Exibição de erros gerais do formulário -->
    {% if form.errors %}
    <div class="alert alert-danger">
        <h4 class="alert-heading">Por favor, corrija os seguintes erros:</h4>
        <ul class="mb-0">
            {% for field, errors in form.errors.items %}
                {% for error in errors %}
                    <li><strong>{{ field|title }}:</strong> {{ error }}</li>
                {% endfor %}
            {% endfor %}
        </ul>
    </div>
    {% endif %}

    <div class="card mb-4">
        <div class="card-body">
            <form method="post" action="{% url 'formacompanhamento:registro_pagamento_update' form.instance.pk %}" enctype="multipart/form-data">
                {% csrf_token %}
                
                <!-- CAMPOS CLIENTE E PRESTADOR -->
                <h4 class="mt-2">Tipo de Serviço</h4>
                <div class="row mb-3">
                    <div class="col-md-4 form-group">
                        <label for="id_tipo_servicos" class="form-label">Tipo de Serviço</label>
                        {{ form.tipo_servicos|add_class:"form-control"|add_error_class:"is-invalid" }}
                        {% if form.tipo_servicos.errors %}
                            <div class="error-message">{{ form.tipo_servicos.errors.0 }}</div>
                        {% endif %}
                    </div>
                </div>
                <h4 class="mt-2">Dados do Cliente</h4>
                <div class="row mb-3">
                    <div class="col-md-4 form-group">
                        <label for="id_cliente" class="form-label">Cliente</label>
                        {{ form.cliente|add_class:"form-control"|add_error_class:"is-invalid" }}
                        {% if form.cliente.errors %}
                            <div class="error-message">{{ form.cliente.errors.0 }}</div>
                        {% endif %}
                    </div>
                    <div class="col-md-4">
                        <label for="id_protocolo" class="form-label">Protocolo</label>
                        {{ form.protocolo }}
                    </div>
                    <div class="col-md-4">
                        <label for="id_endereco" class="form-label">Endereço</label>
                        {{ form.endereco }}
                    </div>
                </div>
                <h3>_________________________________________________________________________________</h3>
                <!-- DADOS DO ACIONAMENTO -->
                <h4 class="mt-2">Dados do Acionamento</h4>
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="id_solicitante" class="form-label">Solicitante</label>
                        {{ form.solicitante }}
                    </div>
                    <div class="col-md-2">
                        <label for="id_tipo_contato" class="form-label">Tipo de Contato</label>
                        {{ form.tipo_contato }}
                    </div>
                    <div class="col-md-2">
                        <label for="id_motivo" class="form-label">Motivo</label>
                        <div class="input-group">
                          {{ form.motivo|add_class:"form-control border-danger" }}
                        </div>
                    </div>
                    <div class="col-md-2">
                        <label for="id_quantidade_agentes" class="form-label">Quantidade de Agentes</label>
                        {{ form.quantidade_agentes }}
                    </div>
                </div>
                <h3>_________________________________________________________________________________</h3>
                <!-- DADOS DA OPERAÇÃO -->
                <h4 class="mt-4">Dados da Operação</h4>
                <!-- Bloco do Agente Principal (Sempre visível) -->
                <div class="row mb-3">
                    <div class="col-md-2">
                        <label for="id_prestador" class="form-label">Prestador</label>
                        {{ form.prestador }}
                    </div>
                    <div class="col-md-2">
                        <label for="id_acionamento" class="form-label">Valor de Acionamento</label>
                        {{ form.acionamento }}
                    </div>
                    <div class="col-md-2">
                        <label for="id_franquia_hora" class="form-label">Franquia de Horas</label>
                        {{ form.franquia_hora }}
                    </div>
                    <div class="col-md-2">
                        <label for="id_km_franquia" class="form-label">Franquia de KM</label>
                        {{ form.km_franquia }}
                    </div>
                    <div class="col-md-2">
                        <label for="id_valor_hora_excedente" class="form-label">Valor de Hora Excedente</label>
                        {{ form.valor_hora_excedente }}
                    </div>
                    <div class="col-md-2">
                        <label for="id_valor_km_excedente" class="form-label">Valor de KM Excedente</label>
                        {{ form.valor_km_excedente }}
                    </div>
                </div>
                <div class="row mb-3">
                    <!-- Linha 1: Início de Operação, SLA, Previsão de Chegada, Data e Hora (Chegada), Final de Operação -->
                    <div class="col-md-3">
                        <label for="id_data_hora_inicial" class="form-label">Início de Operação</label>
                        <div class="input-group">
                            {{ form.data_hora_inicial }}
                            <button type="button" class="btn btn-primary" id="btn_inicial" onclick="registrarDataHora('id_data_hora_inicial', 'btn_inicial')">Registrar</button>
                        </div>
                    </div>
                    <div class="col-md-1">
                        <label for="id_sla" class="form-label">SLA</label>
                        {{ form.sla }}
                    </div>
                    <div class="col-md-2">
                        <label for="id_previsa_chegada" class="form-label">Previsão de Chegada</label>
                        {{ form.previsa_chegada }}
                    </div>
                    <div class="col-md-3">
                        <label for="id_data_hora_chegada" class="form-label">Data e Hora (Chegada)</label>
                        <div class="input-group">
                            {{ form.data_hora_chegada }}
                            <button type="button" class="btn btn-primary" id="btn_chegada" onclick="registrarDataHora('id_data_hora_chegada', 'btn_chegada')">Registrar</button>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <label for="id_data_hora_final" class="form-label">Final de Operação</label>
                        <div class="input-group">
                            {{ form.data_hora_final }}
                            <button type="button" class="btn btn-primary" id="btn_final" onclick="registrarDataHora('id_data_hora_final', 'btn_final')">Registrar</button>
                        </div>
                    </div>
                </div>
                <div class="row mb-3">
                    <!-- Linha 2: Km Inicial, Km Final, KM Total, KM Excedente, Hora Excedente -->
                    <div class="col-md-2">
                        <label for="id_hora_total" class="form-label">Hora Total</label>
                        {{ form.hora_total }}
                    </div>
                    <div class="col-md-2">
                        <label for="id_km_inicial" class="form-label">Km Inicial</label>
                        {{ form.km_inicial }}
                    </div>
                    <div class="col-md-2">
                        <label for="id_km_final" class="form-label">Km Final</label>
                        {{ form.km_final }}
                    </div>
                    <div class="col-md-2">
                        <label for="id_km_total" class="form-label">KM Total</label>
                        {{ form.km_total }}
                    </div>
                    <div class="col-md-2">
                        <label for="id_km_excedente" class="form-label">KM Excedente</label>
                        {{ form.km_excedente }}
                    </div>
                    <div class="col-md-2">
                        <label for="id_hora_excedente" class="form-label">Hora Excedente</label>
                        {{ form.hora_excedente }}
                    </div>
                </div>
                <h3>_________________________________________________________________________________</h3>
                <!-- Botão de adicionar agentes -->
                <button type="button" id="btnAdicionarAgente" class="btn btn-secondary mb-3">Adicionar Agente</button>

                <h5>Agentes Adicionais</h5>
                <div id="agentes-container">
                    <!-- Bloco para Agente Adicional 1 -->
                    <div class="agente-dinamico" id="agente1" style="display: none;">
                        <div class="row mb-3">
                            <div class="col-md-3">
                                <label for="id_prestador1" class="form-label">Prestador</label>
                                {{ form.prestador1|add_class:"prestador-select" }}
                            </div>
                            <div class="col-md-1">
                                <label for="id_acionamento1" class="form-label">Acionamento</label>
                                {{ form.acionamento1 }}
                            </div>
                            <div class="col-md-2">
                                <label for="id_km_franquia1" class="form-label">Franquia de KM</label>
                                {{ form.km_franquia1 }}
                            </div>
                            <div class="col-md-2">
                                <label for="id_franquia_hora1" class="form-label">Franquia Hora</label>
                                {{ form.franquia_hora1 }}
                            </div>
                            <div class="col-md-2">
                                <label for="id_valor_hora_excedente1" class="form-label">Valor Hora Excedente</label>
                                {{ form.valor_hora_excedente1 }}
                            </div>
                            <div class="col-md-2">
                                <label for="id_hora_excedente1" class="form-label">Hora Excedente</label>
                                {{ form.hora_excedente1 }}
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label for="id_data_hora_inicial1" class="form-label">Início de Operação 1</label>
                                <div class="input-group">
                                    {{ form.data_hora_inicial1 }}
                                    <button type="button" class="btn btn-primary" id="btn_inicial1" onclick="registrarDataHora('id_data_hora_inicial1', 'btn_inicial1')">Registrar</button>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <label for="id_data_hora_chegada1" class="form-label">Data e Hora (Chegada) 1</label>
                                <div class="input-group">
                                    {{ form.data_hora_chegada1 }}
                                    <button type="button" class="btn btn-primary" id="btn_chegada1" onclick="registrarDataHora('id_data_hora_chegada1', 'btn_chegada1')">Registrar</button>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <label for="id_data_hora_final1" class="form-label">Final de Operação 1</label>
                                <div class="input-group">
                                    {{ form.data_hora_final1 }}
                                    <button type="button" class="btn btn-primary" id="btn_final1" onclick="registrarDataHora('id_data_hora_final1', 'btn_final1')">Registrar</button>
                                </div>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label for="id_km_inicial1" class="form-label">Km Inicial 1</label>
                                {{ form.km_inicial1 }}
                            </div>
                            <div class="col-md-4">
                                <label for="id_km_final1" class="form-label">Km Final 1</label>
                                {{ form.km_final1 }}
                            </div>
                            <div class="col-md-4">
                                <label for="id_km_total1" class="form-label">KM Total 1</label>
                                {{ form.km_total1 }}
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-3">
                                <label for="id_km_excedente1" class="form-label">KM Excedente 1</label>
                                {{ form.km_excedente1 }}
                            </div>
                            <div class="col-md-3">
                                <label for="id_valor_total_km_excedente1" class="form-label">Valor KM Excedente 1</label>
                                {{ form.valor_km_excedente1 }}
                            </div>
                            <div class="col-md-2">
                                <label for="id_hora_total1" class="form-label">Hora Total 1</label>
                                <input type="text" name="hora_total1" id="id_hora_total1" class="form-control" placeholder="Hora Total" readonly>
                            </div>
                            <div class="col-md-2">
                                <label for="id_motivo1" class="form-label">Motivo</label>
                                <div class="input-group">
                                  {{ form.motivo1|add_class:"form-control border-danger" }}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Bloco para Agente Adicional 2 -->
                <div class="agente-dinamico" id="agente2" style="display: none;">
                        <h3>_______________________________________________________________________________</h3>
                        <div class="row mb-3">
                            <div class="col-md-3">
                                <label for="id_prestador2" class="form-label">Prestador</label>
                                {{ form.prestador2|add_class:"prestador-select" }}
                            </div>
                            <div class="col-md-1">
                                <label for="id_acionamento2" class="form-label">Acionamento</label>
                                {{ form.acionamento2 }}
                            </div>
                            <div class="col-md-2">
                                <label for="id_km_franquia2" class="form-label">Franquia de KM</label>
                                {{ form.km_franquia2 }}
                            </div>
                            <div class="col-md-2">
                                <label for="id_franquia_hora2" class="form-label">Franquia Hora</label>
                                {{ form.franquia_hora2 }}
                            </div>
                            <div class="col-md-2">
                                <label for="id_valor_hora_excedente2" class="form-label">Valor Hora Excedente</label>
                                {{ form.valor_hora_excedente2 }}
                            </div>
                            <div class="col-md-2">
                                <label for="id_hora_excedente2" class="form-label">Hora Excedente</label>
                                {{ form.hora_excedente2 }}
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label for="id_data_hora_inicial2" class="form-label">Início de Operação 2</label>
                                <div class="input-group">
                                    {{ form.data_hora_inicial2 }}
                                    <button type="button" class="btn btn-primary" id="btn_inicial2" onclick="registrarDataHora('id_data_hora_inicial2', 'btn_inicial2')">Registrar</button>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <label for="id_data_hora_chegada2" class="form-label">Data e Hora (Chegada) 2</label>
                                <div class="input-group">
                                    {{ form.data_hora_chegada2 }}
                                    <button type="button" class="btn btn-primary" id="btn_chegada2" onclick="registrarDataHora('id_data_hora_chegada2', 'btn_chegada2')">Registrar</button>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <label for="id_data_hora_final2" class="form-label">Final de Operação 2</label>
                                <div class="input-group">
                                    {{ form.data_hora_final2 }}
                                    <button type="button" class="btn btn-primary" id="btn_final2" onclick="registrarDataHora('id_data_hora_final2', 'btn_final2')">Registrar</button>
                                </div>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label for="id_km_inicial2" class="form-label">Km Inicial 2</label>
                                {{ form.km_inicial2 }}
                            </div>
                            <div class="col-md-4">
                                <label for="id_km_final2" class="form-label">Km Final 2</label>
                                {{ form.km_final2 }}
                            </div>
                            <div class="col-md-4">
                                <label for="id_km_total2" class="form-label">KM Total 2</label>
                                {{ form.km_total2 }}
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-3">
                                <label for="id_km_excedente2" class="form-label">KM Excedente 2</label>
                                {{ form.km_excedente2 }}
                            </div>
                            <div class="col-md-3">
                                <label for="id_valor_total_km_excedente2" class="form-label">Valor KM Excedente 2</label>
                                {{ form.valor_km_excedente2 }}
                            </div>
                            <div class="col-md-3">
                                <label for="id_hora_total2" class="form-label">Hora Total 2</label>
                                <input type="text" name="hora_total2" id="id_hora_total2" class="form-control" placeholder="Hora Total" readonly>
                            </div>
                            <div class="col-md-3">
                                <label for="id_motivo2" class="form-label">Motivo</label>
                                <div class="input-group">
                                  {{ form.motivo2|add_class:"form-control border-danger" }}
                                </div>
                            </div>
                        </div>
                    </div>
                <h3>_________________________________________________________________________________</h3>
                <!-- Bloco para Agente Adicional 3 -->
                <div class="agente-dinamico" id="agente3" style="display: none;">
                        <div class="row mb-3">
                            <div class="col-md-3">
                                <label for="id_prestador3" class="form-label">Prestador</label>
                                {{ form.prestador3|add_class:"prestador-select" }}
                            </div>
                            <div class="col-md-1">
                                <label for="id_acionamento3" class="form-label">Acionamento</label>
                                {{ form.acionamento3 }}
                            </div>
                            <div class="col-md-2">
                                <label for="id_km_franquia3" class="form-label">Franquia de KM</label>
                                {{ form.km_franquia3 }}
                            </div>
                            <div class="col-md-2">
                                <label for="id_franquia_hora3" class="form-label">Franquia Hora</label>
                                {{ form.franquia_hora3 }}
                            </div>
                            <div class="col-md-2">
                                <label for="id_valor_hora_excedente3" class="form-label">Valor Hora Excedente</label>
                                {{ form.valor_hora_excedente3 }}
                            </div>
                            <div class="col-md-2">
                                <label for="id_hora_excedente3" class="form-label">Hora Excedente</label>
                                {{ form.hora_excedente3 }}
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label for="id_data_hora_inicial3" class="form-label">Início de Operação 3</label>
                                <div class="input-group">
                                    {{ form.data_hora_inicial3 }}
                                    <button type="button" class="btn btn-primary" id="btn_inicial3" onclick="registrarDataHora('id_data_hora_inicial3', 'btn_inicial3')">Registrar</button>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <label for="id_data_hora_chegada3" class="form-label">Data e Hora (Chegada) 3</label>
                                <div class="input-group">
                                    {{ form.data_hora_chegada3 }}
                                    <button type="button" class="btn btn-primary" id="btn_chegada3" onclick="registrarDataHora('id_data_hora_chegada3', 'btn_chegada3')">Registrar</button>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <label for="id_data_hora_final3" class="form-label">Final de Operação 3</label>
                                <div class="input-group">
                                    {{ form.data_hora_final3 }}
                                    <button type="button" class="btn btn-primary" id="btn_final3" onclick="registrarDataHora('id_data_hora_final3', 'btn_final3')">Registrar</button>
                                </div>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label for="id_km_inicial3" class="form-label">Km Inicial 3</label>
                                {{ form.km_inicial3 }}
                            </div>
                            <div class="col-md-4">
                                <label for="id_km_final3" class="form-label">Km Final 3</label>
                                {{ form.km_final3 }}
                            </div>
                            <div class="col-md-4">
                                <label for="id_km_total3" class="form-label">KM Total 3</label>
                                {{ form.km_total3 }}
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-3">
                                <label for="id_km_excedente3" class="form-label">KM Excedente 3</label>
                                {{ form.km_excedente3 }}
                            </div>
                            <div class="col-md-3">
                                <label for="id_valor_total_km_excedente3" class="form-label">Valor KM Excedente 3</label>
                                {{ form.valor_km_excedente3 }}
                            </div>
                            <div class="col-md-3">
                                <label for="id_hora_total3" class="form-label">Hora Total 3</label>
                                <input type="text" name="hora_total3" id="id_hora_total3" class="form-control" placeholder="Hora Total" readonly>
                            </div>
                            <div class="col-md-3">
                                <label for="id_motivo3" class="form-label">Motivo</label>
                                <div class="input-group">
                                  {{ form.motivo3|add_class:"form-control border-danger" }}
                                </div>
                            </div>
                        </div>
                    </div>
                <h3>_________________________________________________________________________________</h3>
                <!-- DADOS GERAIS -->
                <h4 class="mt-4">Dados Gerais</h4>
                <!-- CAMPOS Marca / Modelo, Ano Fabricação / Modelo e Cor -->
                <div class="row mb-3">
                    <div class="col-md-3">
                        <label for="id_modelo" class="form-label">Marca / Modelo</label>
                        {{ form.modelo }}
                    </div>
                    <div class="col-md-3">
                        <label for="id_ano" class="form-label">Ano Fabricação / Modelo</label>
                        {{ form.ano }}
                    </div>
                    <div class="col-md-3">
                        <label for="id_cor" class="form-label">Cor</label>
                        {{ form.cor }}
                    </div>
                </div>

                <!-- Botão para revelar as placas -->
                <button type="button" id="btnAdicionarPlaca" class="btn btn-secondary mb-3">Adicionar Placa</button>

                <!-- Linha com as 3 placas (inicialmente ocultas) -->
                <div class="row mb-3">
                    <div class="col-md-4 placa-dinamica" id="placa1" style="display: none;">
                        <label for="id_placas1" class="form-label">Placa1</label>
                        {{ form.placas1 }}
                    </div>
                    <div class="col-md-4 placa-dinamica" id="placa2" style="display: none;">
                        <label for="id_placas2" class="form-label">Placa2</label>
                        {{ form.placas2 }}
                    </div>
                    <div class="col-md-4 placa-dinamica" id="placa3" style="display: none;">
                        <label for="id_placas3" class="form-label">Placa3</label>
                        {{ form.placas3 }}
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-2">
                        <label for="id_rastreador" class="form-label">Rastreador</label>
                        {{ form.rastreador }}
                    </div>
                    <div class="col-md-2" style="display: none;" id="id_equipamento_field">
                        <label for="id_id_equipamento" class="form-label">ID Equipamento</label>
                        {{ form.id_equipamento }}
                    </div>
                    <div class="col-md-6" style="display: none;" id="ultima_posicao_field">
                        <label for="id_ultima_posicao" class="form-label">Endereço da Última Posição</label>
                        {{ form.ultima_posicao }}
                    </div>
                    <div class="col-md-2" style="display: none;" id="latlong_field">
                        <label for="id_latlong" class="form-label">Latitude - Longitude</label>
                        {{ form.latlong }}
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-2">
                        <label for="id_isca" class="form-label">Isca</label>
                        {{ form.isca }}
                    </div>
                    <div class="col-md-2" style="display: none;" id="id_isca_field">
                        <label for="id_id_isca" class="form-label">ID Equipamento</label>
                        {{ form.id_isca }}
                    </div>
                    <div class="col-md-6" style="display: none;" id="ultima_posicao_isca_field">
                        <label for="id_ultima_posicao_isca" class="form-label">Endereço da Última Posição</label>
                        {{ form.ultima_posicao_isca }}
                    </div>
                    <div class="col-md-2" style="display: none;" id="latlong_isca_field">
                        <label for="id_latlong_isca" class="form-label">Latitude - Longitude</label>
                        {{ form.latlong_isca }}
                    </div>
                </div>

                <div class="col-md-12">
                    <label for="id_descricao" class="form-label">descricao</label>
                    {{ form.descricao }}
                </div>
                <h3>_________________________________________________________________________________</h3>
                <!-- IMAGENS -->
                <h4 class="mt-4">Imagens</h4>
                <div id="imagens-groups">
                
                  <!-- Grupo 1: imagem1 a imagem6 -->
                  <div class="row mb-3 image-group" style="display: none;">
                    <div class="col-md-2">
                      <label for="id_imagem1" class="form-label">Imagem 1</label>
                      {{ form.imagem1 }}
                    </div>
                    <div class="col-md-2">
                      <label for="id_imagem2" class="form-label">Imagem 2</label>
                      {{ form.imagem2 }}
                    </div>
                    <div class="col-md-2">
                      <label for="id_imagem3" class="form-label">Imagem 3</label>
                      {{ form.imagem3 }}
                    </div>
                    <div class="col-md-2">
                      <label for="id_imagem4" class="form-label">Imagem 4</label>
                      {{ form.imagem4 }}
                    </div>
                    <div class="col-md-2">
                      <label for="id_imagem5" class="form-label">Imagem 5</label>
                      {{ form.imagem5 }}
                    </div>
                    <div class="col-md-2">
                      <label for="id_imagem6" class="form-label">Imagem 6</label>
                      {{ form.imagem6 }}
                    </div>
                  </div>
                
                  <!-- Grupo 2: imagem7 a imagem12 -->
                  <div class="row mb-3 image-group" style="display: none;">
                    <div class="col-md-2">
                      <label for="id_imagem7" class="form-label">Imagem 7</label>
                      {{ form.imagem7 }}
                    </div>
                    <div class="col-md-2">
                      <label for="id_imagem8" class="form-label">Imagem 8</label>
                      {{ form.imagem8 }}
                    </div>
                    <div class="col-md-2">
                      <label for="id_imagem9" class="form-label">Imagem 9</label>
                      {{ form.imagem9 }}
                    </div>
                    <div class="col-md-2">
                      <label for="id_imagem10" class="form-label">Imagem 10</label>
                      {{ form.imagem10 }}
                    </div>
                    <div class="col-md-2">
                      <label for="id_imagem11" class="form-label">Imagem 11</label>
                      {{ form.imagem11 }}
                    </div>
                    <div class="col-md-2">
                      <label for="id_imagem12" class="form-label">Imagem 12</label>
                      {{ form.imagem12 }}
                    </div>
                  </div>
                
                  <!-- Grupo 3: imagem13 a imagem18 -->
                  <div class="row mb-3 image-group" style="display: none;">
                    <div class="col-md-2">
                      <label for="id_imagem13" class="form-label">Imagem 13</label>
                      {{ form.imagem13 }}
                    </div>
                    <div class="col-md-2">
                      <label for="id_imagem14" class="form-label">Imagem 14</label>
                      {{ form.imagem14 }}
                    </div>
                    <div class="col-md-2">
                      <label for="id_imagem15" class="form-label">Imagem 15</label>
                      {{ form.imagem15 }}
                    </div>
                    <div class="col-md-2">
                      <label for="id_imagem16" class="form-label">Imagem 16</label>
                      {{ form.imagem16 }}
                    </div>
                    <div class="col-md-2">
                      <label for="id_imagem17" class="form-label">Imagem 17</label>
                      {{ form.imagem17 }}
                    </div>
                    <div class="col-md-2">
                      <label for="id_imagem18" class="form-label">Imagem 18</label>
                      {{ form.imagem18 }}
                    </div>
                  </div>
                
                  <!-- Grupo 4: imagem19 a imagem24 -->
                  <div class="row mb-3 image-group" style="display: none;">
                    <div class="col-md-2">
                      <label for="id_imagem19" class="form-label">Imagem 19</label>
                      {{ form.imagem19 }}
                    </div>
                    <div class="col-md-2">
                      <label for="id_imagem20" class="form-label">Imagem 20</label>
                      {{ form.imagem20 }}
                    </div>
                    <div class="col-md-2">
                      <label for="id_imagem21" class="form-label">Imagem 21</label>
                      {{ form.imagem21 }}
                    </div>
                    <div class="col-md-2">
                      <label for="id_imagem22" class="form-label">Imagem 22</label>
                      {{ form.imagem22 }}
                    </div>
                    <div class="col-md-2">
                      <label for="id_imagem23" class="form-label">Imagem 23</label>
                      {{ form.imagem23 }}
                    </div>
                    <div class="col-md-2">
                      <label for="id_imagem24" class="form-label">Imagem 24</label>
                      {{ form.imagem24 }}
                    </div>
                  </div>
                
                  <!-- Grupo 5: imagem25 a imagem30 -->
                  <div class="row mb-3 image-group" style="display: none;">
                    <div class="col-md-2">
                      <label for="id_imagem25" class="form-label">Imagem 25</label>
                      {{ form.imagem25 }}
                    </div>
                    <div class="col-md-2">
                      <label for="id_imagem26" class="form-label">Imagem 26</label>
                      {{ form.imagem26 }}
                    </div>
                    <div class="col-md-2">
                      <label for="id_imagem27" class="form-label">Imagem 27</label>
                      {{ form.imagem27 }}
                    </div>
                    <div class="col-md-2">
                      <label for="id_imagem28" class="form-label">Imagem 28</label>
                      {{ form.imagem28 }}
                    </div>
                    <div class="col-md-2">
                      <label for="id_imagem29" class="form-label">Imagem 29</label>
                      {{ form.imagem29 }}
                    </div>
                    <div class="col-md-2">
                      <label for="id_imagem30" class="form-label">Imagem 30</label>
                      {{ form.imagem30 }}
                    </div>
                  </div>
                </div>

                <!-- Botão para exibir os grupos progressivamente -->
                <button type="button" class="btn btn-primary" onclick="showMoreImages()">
                  Adicionar fotos
                </button>

                <div class="d-flex justify-content-between mt-4">
                    <button type="submit" class="btn btn-primary">Salvar</button>
                    <a href="{% url 'formacompanhamento:registro_pagamento_list' %}" class="btn btn-secondary">Cancelar e Voltar</a>
                </div>
            </form>
        </div>
    </div>
</div>

{% if form.errors %}
    <div class="alert alert-danger">
        <ul>
            {% for field, errors in form.errors.items %}
                <li><strong>{{ field }}</strong>: {{ errors|join:", " }}</li>
            {% endfor %}
        </ul>
    </div>
{% endif %}

<!-- Script para exibir os blocos dos agentes adicionais e realizar os cálculos, incluindo a atualização automática dos campos via motivo -->
<script>
document.addEventListener("DOMContentLoaded", function() {

    // Inicializar objeto para armazenar dados dos prestadores por bloco
    window.prestadorData = {};

    // ======================================================
    // 1. registrarDataHora: Preenche o campo com a data/hora atual e oculta o botão.
    function registrarDataHora(inputId, btnId) {
        var agora = new Date();
        var ano = agora.getFullYear();
        var mes = ("0" + (agora.getMonth() + 1)).slice(-2);
        var dia = ("0" + agora.getDate()).slice(-2);
        var hora = ("0" + agora.getHours()).slice(-2);
        var minutos = ("0" + agora.getMinutes()).slice(-2);
        var segundos = ("0" + agora.getSeconds()).slice(-2);
        var dataHoraFormatada = ano + "-" + mes + "-" + dia + " " + hora + ":" + minutos + ":" + segundos;
        console.log("[registrarDataHora] Input ID:", inputId, "Valor calculado:", dataHoraFormatada);
        
        var inputField = document.getElementById(inputId);
        if (inputField) {
            inputField.value = dataHoraFormatada;
            console.log("[registrarDataHora] Campo", inputId, "preenchido com", dataHoraFormatada);
        } else {
            console.error("[registrarDataHora] Elemento com id", inputId, "não encontrado.");
        }
        
        var botao = document.getElementById(btnId);
        if (botao) {
            botao.style.display = "none";
            console.log("[registrarDataHora] Botão", btnId, "ocultado.");
        } else {
            console.error("[registrarDataHora] Elemento com id", btnId, "não encontrado.");
        }
        
        // Se o campo for de início ou final, dispara os cálculos da Hora Total e Hora Excedente.
        if(inputId.indexOf("id_data_hora_inicial") === 0 || inputId.indexOf("id_data_hora_final") === 0){
            var block = inputId.replace(/id_data_hora_(inicial|final)/, "");
            calculateHoraTotal(block);
            calculateHoraExcedente(block);
        }
    }
    window.registrarDataHora = registrarDataHora;
    
    
    // ======================================================
    // 2. attachPrestadorChangeListener: Atualiza os campos do prestador via AJAX.
    function attachPrestadorChangeListener(selectElem) {
        selectElem.addEventListener("change", function() {
            var prestadorId = this.value;
            var block = this.id.replace("id_prestador", "");
            console.log("Prestador selecionado - ID:", prestadorId, "Block:", block);
            
            if (prestadorId) {
                var url = "{% url 'formacompanhamento:prestador_detail' %}?id=" + prestadorId;
                console.log("Fazendo requisição para:", url);
                
                fetch(url)
                    .then(function(response) {
                        console.log("Resposta recebida:", response.status, response.statusText);
                        if (!response.ok) {
                            throw new Error("Erro na resposta da rede: " + response.status);
                        }
                        return response.json();
                    })
                    .then(function(data) {
                        console.log("Dados do prestador recebidos:", data);
                        if (!data.error) {
                            // Armazenar dados do prestador específico para este bloco
                            if (!window.prestadorData) {
                                window.prestadorData = {};
                            }
                            window.prestadorData[block] = data;
                            console.log("Dados do prestador armazenados para block", block, ":", data);
                            
                            // Preencher campos do prestador automaticamente
                            fillPrestadorFields(block, data);
                            
                            // Atualizar campos baseado no motivo atual
                            window.updateAcionamentoByMotivo(block);
                            calculateHoraExcedente(block);
                        } else {
                            console.error("Erro nos dados:", data.error);
                        }
                    })
                    .catch(function(error) {
                        console.error("Erro ao buscar os dados do prestador:", error);
                    });
            } else {
                console.log("Nenhum prestador selecionado para block", block);
                if (window.prestadorData && window.prestadorData[block]) {
                    delete window.prestadorData[block];
                }
            }
        });
    }

    // Função para preencher campos do prestador automaticamente
    function fillPrestadorFields(block, data) {
        // Campos básicos do prestador - usando valores padrão
        var fieldsToFill = {
            'acionamento': data.valor_acionamento || "",
            'franquia_hora': data.franquia_hora_armado || "",
            'km_franquia': data.franquia_km_armado || "",
            'valor_hora_excedente': data.valorh_armado || "",
            'valor_km_excedente': data.valorkm_armado || ""
        };

        // Preencher cada campo
        Object.keys(fieldsToFill).forEach(function(fieldName) {
            var fieldId = "id_" + fieldName + block;
            var fieldElement = document.getElementById(fieldId);
            if (fieldElement && fieldsToFill[fieldName] !== "") {
                fieldElement.value = fieldsToFill[fieldName];
                console.log("Campo " + fieldName + " preenchido:", fieldsToFill[fieldName]);
            }
        });
    }
    var prestadorSelects = document.querySelectorAll(".prestador-select");
    prestadorSelects.forEach(function(selectElem) {
        attachPrestadorChangeListener(selectElem);
    });
    var mainSelect = document.getElementById("id_prestador");
    if (mainSelect && !mainSelect.classList.contains("prestador-select")) {
        attachPrestadorChangeListener(mainSelect);
    }
    
    
    // ======================================================
    // 3. updateAcionamentoByMotivo: Atualiza os campos de acordo com o motivo selecionado.
    window.updateAcionamentoByMotivo = function(block) {
        console.log("updateAcionamentoByMotivo chamado com block:", block);
        
        var motivoField = document.getElementById("id_motivo" + block);
        var motivo = motivoField ? motivoField.value.trim().toLowerCase() : "";
        
        console.log("Motivo selecionado:", motivo);
        
        // Obter dados do prestador específico para este bloco
        var prestadorData = window.prestadorData && window.prestadorData[block] ? window.prestadorData[block] : null;
        console.log("Dados do prestador para block", block, ":", prestadorData);

        var acionamentoField = document.getElementById("id_acionamento" + block);
        var franquiaHoraField = document.getElementById("id_franquia_hora" + block);
        var kmFranquiaField = document.getElementById("id_km_franquia" + block);
        var valorHoraExcedenteField = document.getElementById("id_valor_hora_excedente" + block);
        var valorKmExcedenteField = document.getElementById("id_valor_km_excedente" + block);

        console.log("Campos encontrados:");
        console.log("- acionamentoField:", acionamentoField);
        console.log("- franquiaHoraField:", franquiaHoraField);
        console.log("- kmFranquiaField:", kmFranquiaField);
        console.log("- valorHoraExcedenteField:", valorHoraExcedenteField);
        console.log("- valorKmExcedenteField:", valorKmExcedenteField);

        // Verificar se temos dados do prestador
        if (!prestadorData) {
            console.log("Nenhum dado de prestador disponível para block", block);
            return;
        }

        // Exemplos de motivos - corrigindo a comparação
        if (motivo === "antenista") {
            console.log("Aplicando valores para antenista");
            if (acionamentoField) { 
                acionamentoField.value = prestadorData.valor_antenista || ""; 
                console.log("Valor acionamento antenista:", prestadorData.valor_antenista);
            }
            if (franquiaHoraField) { 
                franquiaHoraField.value = prestadorData.franquia_hora_antenista || ""; 
                console.log("Franquia hora antenista:", prestadorData.franquia_hora_antenista);
            }
            if (kmFranquiaField) { 
                kmFranquiaField.value = prestadorData.franquia_km_antenista || ""; 
                console.log("Franquia KM antenista:", prestadorData.franquia_km_antenista);
            }
            if (valorHoraExcedenteField) { 
                valorHoraExcedenteField.value = prestadorData.valorh_antenista || ""; 
                console.log("Valor hora excedente antenista:", prestadorData.valorh_antenista);
            }
            if (valorKmExcedenteField) { 
                valorKmExcedenteField.value = prestadorData.valorkm_antenista || ""; 
                console.log("Valor KM excedente antenista:", prestadorData.valorkm_antenista);
            }
        } else if (motivo === "pronta resposta armado" || motivo === "ponta resposta armado") {
            console.log("Aplicando valores para pronta resposta armado");
            if (acionamentoField) { 
                acionamentoField.value = prestadorData.valor_prontaresposta_armado || ""; 
                console.log("Valor acionamento armado:", prestadorData.valor_prontaresposta_armado);
            }
            if (franquiaHoraField) { 
                franquiaHoraField.value = prestadorData.franquia_hora_armado || ""; 
                console.log("Franquia hora armado:", prestadorData.franquia_hora_armado);
            }
            if (kmFranquiaField) { 
                kmFranquiaField.value = prestadorData.franquia_km_armado || ""; 
                console.log("Franquia KM armado:", prestadorData.franquia_km_armado);
            }
            if (valorHoraExcedenteField) { 
                valorHoraExcedenteField.value = prestadorData.valorh_armado || ""; 
                console.log("Valor hora excedente armado:", prestadorData.valorh_armado);
            }
            if (valorKmExcedenteField) { 
                valorKmExcedenteField.value = prestadorData.valorkm_armado || ""; 
                console.log("Valor KM excedente armado:", prestadorData.valorkm_armado);
            }
        } else if (motivo === "pronta resposta desarmado" || motivo === "ponta resposta desarmado") {
            console.log("Aplicando valores para pronta resposta desarmado");
            if (acionamentoField) { 
                acionamentoField.value = prestadorData.valor_prontaresposta_desarmado || ""; 
                console.log("Valor acionamento desarmado:", prestadorData.valor_prontaresposta_desarmado);
            }
            if (franquiaHoraField) { 
                franquiaHoraField.value = prestadorData.franquia_hora_desarmado || ""; 
                console.log("Franquia hora desarmado:", prestadorData.franquia_hora_desarmado);
            }
            if (kmFranquiaField) { 
                kmFranquiaField.value = prestadorData.franquia_km_desarmado || ""; 
                console.log("Franquia KM desarmado:", prestadorData.franquia_km_desarmado);
            }
            if (valorHoraExcedenteField) { 
                valorHoraExcedenteField.value = prestadorData.valorh_desarmado || ""; 
                console.log("Valor hora excedente desarmado:", prestadorData.valorh_desarmado);
            }
            if (valorKmExcedenteField) { 
                valorKmExcedenteField.value = prestadorData.valorkm_desarmado || ""; 
                console.log("Valor KM excedente desarmado:", prestadorData.valorkm_desarmado);
            }
        } else {
            console.log("Motivo não reconhecido, aplicando valor padrão");
            if (acionamentoField) { 
                acionamentoField.value = prestadorData.valor_acionamento || ""; 
                console.log("Valor acionamento padrão:", prestadorData.valor_acionamento);
            }
            if (franquiaHoraField) { 
                franquiaHoraField.value = prestadorData.franquia_hora_armado || ""; 
                console.log("Franquia hora padrão:", prestadorData.franquia_hora_armado);
            }
            if (kmFranquiaField) { 
                kmFranquiaField.value = prestadorData.franquia_km_armado || ""; 
                console.log("Franquia KM padrão:", prestadorData.franquia_km_armado);
            }
            if (valorHoraExcedenteField) { 
                valorHoraExcedenteField.value = prestadorData.valorh_armado || ""; 
                console.log("Valor hora excedente padrão:", prestadorData.valorh_armado);
            }
            if (valorKmExcedenteField) { 
                valorKmExcedenteField.value = prestadorData.valorkm_armado || ""; 
                console.log("Valor KM excedente padrão:", prestadorData.valorkm_armado);
            }
        }
    };
    
    // Inicializar listeners para campos de motivo
    window.initializeMotivoListeners = function() {
        // Listener para o motivo principal
        var motivoPrincipal = document.getElementById("id_motivo");
        if (motivoPrincipal) {
            motivoPrincipal.addEventListener("change", function() {
                window.updateAcionamentoByMotivo("");
            });
        }

        // Listeners para motivos dos agentes adicionais
        for (var i = 1; i <= 3; i++) {
            var motivoField = document.getElementById("id_motivo" + i);
            if (motivoField) {
                motivoField.addEventListener("change", function() {
                    var block = this.id.replace("id_motivo", "");
                    window.updateAcionamentoByMotivo(block);
                });
            }
        }
    };
    
    // Inicializar listeners de motivo
    window.initializeMotivoListeners();
    
    
    // ======================================================
    // 4. toggleFieldVisibility: Exibe/oculta campos com base no valor selecionado.
    function toggleFieldVisibility(selectId, fieldIds, expectedValue="sim") {
        var selectElem = document.getElementById(selectId);
        if (!selectElem) return;
        function updateVisibility() {
            var valor = selectElem.value.toLowerCase();
            fieldIds.forEach(function(fieldId) {
                var fieldElem = document.getElementById(fieldId);
                if (fieldElem) {
                    fieldElem.style.display = (valor === expectedValue.toLowerCase()) ? "block" : "none";
                }
            });
        }
        updateVisibility();
        selectElem.addEventListener("change", updateVisibility);
    }
    toggleFieldVisibility("id_rastreador", ["id_equipamento_field", "ultima_posicao_field", "latlong_field"], "sim");
    toggleFieldVisibility("id_isca", ["id_isca_field", "ultima_posicao_isca_field", "latlong_isca_field"], "sim");
    
    
    // ======================================================
    // 5. calculatePrevisaoChegada: Calcula a previsão de chegada a partir do SLA e da data/hora de início.
    function formatDateTime(dateObj) {
        var ano = dateObj.getFullYear();
        var mes = ("0" + (dateObj.getMonth() + 1)).slice(-2);
        var dia = ("0" + dateObj.getDate()).slice(-2);
        var hora = ("0" + dateObj.getHours()).slice(-2);
        var minutos = ("0" + dateObj.getMinutes()).slice(-2);
        var segundos = ("0" + dateObj.getSeconds()).slice(-2);
        return ano + "-" + mes + "-" + dia + " " + hora + ":" + minutos + ":" + segundos;
    }
    function calculatePrevisaoChegada() {
        var slaElem = document.getElementById("id_sla");
        var inicioElem = document.getElementById("id_data_hora_inicial");
        var previsaoElem = document.getElementById("id_previsa_chegada");
        if (slaElem && inicioElem && previsaoElem) {
            var slaValue = parseFloat(slaElem.value);
            var inicioStr = inicioElem.value;
            if (!isNaN(slaValue) && inicioStr) {
                var inicioISO = inicioStr.indexOf("T") === -1 ? inicioStr.replace(" ", "T") : inicioStr;
                var inicioDate = new Date(inicioISO);
                if (!isNaN(inicioDate.getTime())) {
                    var previsaoDate = new Date(inicioDate.getTime() + slaValue * 60000);
                    previsaoElem.value = formatDateTime(previsaoDate);
                } else {
                    console.error("Data de início inválida:", inicioStr);
                }
            }
        }
    }
    var slaElem = document.getElementById("id_sla");
    if (slaElem) {
        slaElem.addEventListener("input", calculatePrevisaoChegada);
        slaElem.addEventListener("change", calculatePrevisaoChegada);
    }
    var inicioElem = document.getElementById("id_data_hora_inicial");
    if (inicioElem) {
        inicioElem.addEventListener("change", calculatePrevisaoChegada);
        inicioElem.addEventListener("blur", calculatePrevisaoChegada);
    }
    
    
    // ======================================================
    // 6. calculateHoraTotal: Calcula a diferença entre a data/hora final e de início e preenche o campo "Hora Total".
    function parseDateTimeGeneric(dateTimeStr) {
        if (!dateTimeStr) return NaN;
        var isoStr = dateTimeStr.indexOf("T") === -1 ? dateTimeStr.replace(" ", "T") : dateTimeStr;
        return new Date(isoStr);
    }
    function calculateHoraTotal(block) {
        var inicioId = "id_data_hora_inicial" + block;
        var finalId = "id_data_hora_final" + block;
        var totalId = "id_hora_total" + block;
        console.log("Calculando Hora Total para block:", block);
        var inicioElem = document.getElementById(inicioId);
        var finalElem = document.getElementById(finalId);
        var totalElem = document.getElementById(totalId);
        if (inicioElem && finalElem && totalElem) {
            var inicioStr = inicioElem.value.trim();
            var finalStr = finalElem.value.trim();
            console.log("Valores para block", block, ":", inicioStr, finalStr);
            if (inicioStr && finalStr) {
                var inicioDate = parseDateTimeGeneric(inicioStr);
                var finalDate = parseDateTimeGeneric(finalStr);
                if (isNaN(inicioDate.getTime()) || isNaN(finalDate.getTime())) {
                    console.error("Data inválida para block", block);
                    totalElem.value = "";
                    return;
                }
                if (finalDate < inicioDate) {
                    console.error("Data final é anterior à de início para block", block);
                    totalElem.value = "";
                    return;
                }
                var diffMs = finalDate - inicioDate;
                var diffMinutes = Math.floor(diffMs / 60000);
                var hours = Math.floor(diffMinutes / 60);
                var minutes = diffMinutes % 60;
                var minutesStr = minutes < 10 ? "0" + minutes : minutes.toString();
                var resultStr = hours + "." + minutesStr;
                console.log("Hora Total calculada para block", block, ":", resultStr);
                totalElem.value = resultStr;
            } else {
                console.log("Campos vazios para block", block);
                totalElem.value = "";
            }
        } else {
            console.error("Elementos não encontrados para block:", block);
        }
    }
    function attachHoraTotalCalculation(block) {
        var inicioId = "id_data_hora_inicial" + block;
        var finalId = "id_data_hora_final" + block;
        var inicioElem = document.getElementById(inicioId);
        var finalElem = document.getElementById(finalId);
        if (inicioElem) {
            inicioElem.addEventListener("change", function() { 
                calculateHoraTotal(block); 
                calculateHoraExcedente(block);
            });
            inicioElem.addEventListener("blur", function() { 
                calculateHoraTotal(block); 
                calculateHoraExcedente(block);
            });
        } else {
            console.error("Não encontrou o elemento com id:", inicioId);
        }
        if (finalElem) {
            finalElem.addEventListener("change", function() { 
                calculateHoraTotal(block); 
                calculateHoraExcedente(block);
            });
            finalElem.addEventListener("blur", function() { 
                calculateHoraTotal(block); 
                calculateHoraExcedente(block);
            });
        } else {
            console.error("Não encontrou o elemento com id:", finalId);
        }
        // Listener para alterações na franquia de hora
        var franquiaElem = document.getElementById("id_franquia_hora" + block);
        if (franquiaElem) {
            franquiaElem.addEventListener("change", function() { 
                calculateHoraExcedente(block);
            });
            franquiaElem.addEventListener("blur", function() { 
                calculateHoraExcedente(block);
            });
        }
    }
    // Anexa os listeners para o cálculo de Hora Total e Hora Excedente (agente principal e agentes adicionais)
    attachHoraTotalCalculation("");    // Agente principal
    attachHoraTotalCalculation("1");     // Agente adicional 1
    attachHoraTotalCalculation("2");     // Agente adicional 2
    attachHoraTotalCalculation("3");     // Agente adicional 3
    
    
    // ======================================================
    // 7. calculateHoraExcedente: Calcula a "Hora Excedente" como a diferença entre a duração total (em minutos)
    // e a franquia de hora (convertida para minutos). O resultado é exibido no formato H.MM.
    function calculateHoraExcedente(block) {
        var inicioId = "id_data_hora_inicial" + block;
        var finalId = "id_data_hora_final" + block;
        var franquiaId = "id_franquia_hora" + block;
        var excedenteId = "id_hora_excedente" + block;
        var inicioElem = document.getElementById(inicioId);
        var finalElem = document.getElementById(finalId);
        var franquiaElem = document.getElementById(franquiaId);
        var excedenteElem = document.getElementById(excedenteId);
        if (inicioElem && finalElem && franquiaElem && excedenteElem) {
            var inicioStr = inicioElem.value.trim();
            var finalStr = finalElem.value.trim();
            if (inicioStr && finalStr) {
                var inicioDate = parseDateTimeGeneric(inicioStr);
                var finalDate = parseDateTimeGeneric(finalStr);
                if (isNaN(inicioDate.getTime()) || isNaN(finalDate.getTime())) {
                    excedenteElem.value = "";
                    return;
                }
                if (finalDate < inicioDate) {
                    excedenteElem.value = "";
                    return;
                }
                var diffMs = finalDate - inicioDate;
                var diffMinutes = Math.floor(diffMs / 60000);
                var franquia = parseFloat(franquiaElem.value);
                if (isNaN(franquia)) { franquia = 0; }
                var franquiaMinutes = franquia * 60;
                var excedenteMinutes = diffMinutes - franquiaMinutes;
                if (excedenteMinutes < 0) {
                    excedenteMinutes = 0;
                }
                var hoursEx = Math.floor(excedenteMinutes / 60);
                var minutesEx = excedenteMinutes % 60;
                var minutesExStr = minutesEx < 10 ? "0" + minutesEx : minutesEx.toString();
                var resultExStr = hoursEx + "." + minutesExStr;
                console.log("Hora Excedente calculada para block", block, ":", resultExStr);
                excedenteElem.value = resultExStr;
            } else {
                excedenteElem.value = "";
            }
        }
    }
    
    
    // ======================================================
    // 8. calculateKmTotal: Calcula o KM Total e o KM Excedente.
    //     KM Total = Km Final - Km Inicial
    //     KM Excedente = KM Total - Franquia de KM
    function calculateKmTotal(block) {
        var kmInicialElem = document.getElementById("id_km_inicial" + block);
        var kmFinalElem = document.getElementById("id_km_final" + block);
        var kmTotalElem = document.getElementById("id_km_total" + block);
        var kmFranquiaElem = document.getElementById("id_km_franquia" + block);
        var kmExcedenteElem = document.getElementById("id_km_excedente" + block);
        
        console.log("Calculando KM para block:", block);
        
        if(kmInicialElem && kmFinalElem && kmTotalElem) {
            var kmInicial = parseFloat(kmInicialElem.value);
            var kmFinal = parseFloat(kmFinalElem.value);
            console.log("Km Inicial:", kmInicial, "Km Final:", kmFinal);
            if(isNaN(kmInicial) || isNaN(kmFinal)) {
                kmTotalElem.value = "";
                if(kmExcedenteElem) {
                    kmExcedenteElem.value = "";
                }
                console.warn("Valores de KM inválidos para block:", block);
                return;
            }
            var kmTotal = kmFinal - kmInicial;
            kmTotalElem.value = kmTotal;
            console.log("KM Total calculado:", kmTotal);
            if(kmFranquiaElem && kmExcedenteElem) {
                var kmFranquia = parseFloat(kmFranquiaElem.value);
                console.log("Franquia de KM:", kmFranquia);
                if(!isNaN(kmFranquia)) {
                    var kmExcedente = kmTotal - kmFranquia;
                    kmExcedenteElem.value = kmExcedente;
                    console.log("KM Excedente calculado:", kmExcedente);
                } else {
                    kmExcedenteElem.value = "";
                    console.warn("Valor de Franquia de KM inválido para block:", block);
                }
            }
        }
    }
    function attachKmCalculation(block) {
        var kmInicialElem = document.getElementById("id_km_inicial" + block);
        var kmFinalElem = document.getElementById("id_km_final" + block);
        var kmFranquiaElem = document.getElementById("id_km_franquia" + block);
        if(kmInicialElem) {
            kmInicialElem.addEventListener("change", function() { calculateKmTotal(block); });
            kmInicialElem.addEventListener("blur", function() { calculateKmTotal(block); });
        }
        if(kmFinalElem) {
            kmFinalElem.addEventListener("change", function() { calculateKmTotal(block); });
            kmFinalElem.addEventListener("blur", function() { calculateKmTotal(block); });
        }
        if(kmFranquiaElem) {
            kmFranquiaElem.addEventListener("change", function() { calculateKmTotal(block); });
            kmFranquiaElem.addEventListener("blur", function() { calculateKmTotal(block); });
        }
    }
    // Anexa os listeners para o cálculo de KM (agente principal e agentes adicionais)
    attachKmCalculation("");    // Agente principal
    attachKmCalculation("1");     // Agente adicional 1
    attachKmCalculation("2");     // Agente adicional 2
    attachKmCalculation("3");     // Agente adicional 3
    
    
    // ======================================================
    // 9. Evento para exibir os blocos dos agentes adicionais.
    var btnAdicionarAgente = document.getElementById("btnAdicionarAgente");
    if (btnAdicionarAgente) {
        btnAdicionarAgente.addEventListener("click", function() {
            console.log("Botão Adicionar Agente clicado");
            // Pega todos os blocos de agente adicional
            var agentes = document.querySelectorAll(".agente-dinamico");
            console.log("Agentes encontrados:", agentes.length);

            // Procura o primeiro que estiver com display: none
            for (var i = 0; i < agentes.length; i++) {
                console.log("Verificando agente", i, "display:", agentes[i].style.display);
                if (agentes[i].style.display === "none" || agentes[i].style.display === "") {
                    agentes[i].style.display = "block";
                    console.log("Agente", i, "exibido com sucesso");
                    
                    // Adicionar listeners para os campos do agente recém-exibido
                    var agenteId = agentes[i].id;
                    var agenteNumber = agenteId.replace("agente", "");
                    attachHoraTotalCalculation(agenteNumber);
                    attachKmCalculation(agenteNumber);
                    
                    break;
                }
            }
        });
    }
    
    // Função para verificar e mostrar grupos de imagens que têm arquivos
    function checkImageGroups() {
        const imageGroups = document.querySelectorAll('.image-group');
        imageGroups.forEach(group => {
            const inputs = group.querySelectorAll('input[type="file"]');
            let hasFiles = false;
            
            inputs.forEach(input => {
                if (input.files && input.files.length > 0) {
                    hasFiles = true;
                }
            });
            
            // Se o grupo tem arquivos ou está em modo de edição (update), mostra o grupo
            if (hasFiles || window.location.pathname.includes('update')) {
                group.style.display = 'flex';
            } else {
                group.style.display = 'none';
            }
        });
    }

    // Adiciona listeners para os inputs de arquivo
    document.querySelectorAll('input[type="file"]').forEach(input => {
        input.addEventListener('change', checkImageGroups);
    });

    // Verifica os grupos ao carregar a página
    checkImageGroups();

    // Controle de visibilidade dos grupos de imagens
    const btnAdicionarImagens = document.getElementById('btnAdicionarImagens');
    const imagensGroups = document.getElementById('imagens-groups');
    
    if (btnAdicionarImagens && imagensGroups) {
        btnAdicionarImagens.addEventListener('click', function() {
            if (imagensGroups.classList.contains('d-none')) {
                imagensGroups.classList.remove('d-none');
                this.innerHTML = '<i class="fas fa-camera"></i> Ocultar Imagens';
            } else {
                imagensGroups.classList.add('d-none');
                this.innerHTML = '<i class="fas fa-camera"></i> Adicionar Imagens';
            }
        });
    }

    // Controle de visibilidade dos grupos de imagens
    let currentGroupIndex = 0;
    function showMoreImages() {
        const groups = document.querySelectorAll('.image-group');
        if (currentGroupIndex < groups.length) {
            groups[currentGroupIndex].style.display = 'flex';
            currentGroupIndex++;
        }
    }
    window.showMoreImages = showMoreImages;
    // Exibe o primeiro grupo ao carregar, se desejar
    showMoreImages();

    // ======================================================
    // 10. Inicializar agentes que já têm dados
    function initializeExistingAgentes() {
        // Verificar se há dados nos agentes adicionais e exibi-los
        for (var i = 1; i <= 3; i++) {
            var prestadorField = document.getElementById("id_prestador" + i);
            var agenteDiv = document.getElementById("agente" + i);
            
            if (prestadorField && prestadorField.value && agenteDiv) {
                agenteDiv.style.display = "block";
                console.log("Agente", i, "já tem dados, exibindo...");
                
                // Adicionar listeners para os campos do agente
                attachHoraTotalCalculation(i.toString());
                attachKmCalculation(i.toString());
            }
        }
    }
    
    // Inicializar agentes existentes
    initializeExistingAgentes();

    // ======================================================
    // 11. Botão para adicionar placas
    const btnPlaca = document.getElementById("btnAdicionarPlaca");
    if (btnPlaca) {
        btnPlaca.addEventListener("click", function() {
            // Seleciona todas as divs que têm a classe "placa-dinamica"
            const placas = document.querySelectorAll(".placa-dinamica");
            // Procura a primeira que esteja oculta (display: none)
            for (let i = 0; i < placas.length; i++) {
                if (placas[i].style.display === "none") {
                    // Exibe essa placa e para o loop
                    placas[i].style.display = "block";
                    break;
                }
            }
        });
    }

    // ======================================================
    // 12. Inicializar placas que já têm dados
    function initializeExistingPlacas() {
        for (var i = 1; i <= 3; i++) {
            var placaField = document.getElementById("id_placas" + i);
            var placaDiv = document.getElementById("placa" + i);
            
            if (placaField && placaField.value && placaDiv) {
                placaDiv.style.display = "block";
                console.log("Placa", i, "já tem dados, exibindo...");
            }
        }
    }
    
    // Inicializar placas existentes
    initializeExistingPlacas();

    // ======================================================
    // 13. Inicializar listeners de motivo quando a página carrega
    function initializeMotivoListeners() {
        console.log("Inicializando listeners de motivo...");
        
        // Listener para o motivo principal
        var motivoPrincipal = document.getElementById("id_motivo");
        if (motivoPrincipal) {
            console.log("Adicionando listener para motivo principal");
            motivoPrincipal.addEventListener("change", function() {
                console.log("Motivo principal alterado para:", this.value);
                window.updateAcionamentoByMotivo("");
            });
        } else {
            console.log("Campo motivo principal não encontrado");
        }

        // Listeners para motivos dos agentes adicionais
        for (var i = 1; i <= 3; i++) {
            var motivoField = document.getElementById("id_motivo" + i);
            if (motivoField) {
                console.log("Adicionando listener para motivo", i);
                motivoField.addEventListener("change", function() {
                    var block = this.id.replace("id_motivo", "");
                    console.log("Motivo", block, "alterado para:", this.value);
                    window.updateAcionamentoByMotivo(block);
                });
            } else {
                console.log("Campo motivo", i, "não encontrado");
            }
        }
    }

    // Inicializar listeners de motivo
    window.initializeMotivoListeners();

    // ======================================================
    // 14. Inicializar dados dos prestadores existentes quando a página carrega
    function initializeExistingPrestadorData() {
        console.log("Inicializando dados dos prestadores existentes...");
        
        // Verificar prestador principal
        var mainPrestadorSelect = document.getElementById("id_prestador");
        if (mainPrestadorSelect && mainPrestadorSelect.value) {
            console.log("Prestador principal já selecionado:", mainPrestadorSelect.value);
            // Disparar evento change para carregar os dados
            mainPrestadorSelect.dispatchEvent(new Event('change'));
        }
        
        // Verificar prestadores dos agentes adicionais
        for (var i = 1; i <= 3; i++) {
            var prestadorSelect = document.getElementById("id_prestador" + i);
            if (prestadorSelect && prestadorSelect.value) {
                console.log("Prestador", i, "já selecionado:", prestadorSelect.value);
                // Disparar evento change para carregar os dados
                prestadorSelect.dispatchEvent(new Event('change'));
            }
        }
    }
    
    // Inicializar dados dos prestadores existentes
    initializeExistingPrestadorData();

});
</script>
    
{% endblock %}
