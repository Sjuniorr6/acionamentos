{% extends 'base.html' %}
{% load widget_tweaks %}
{% block content %}
{% include "components/_header.html" %}

<style>
  /* Garante que as imagens não extrapolem o container */
  .img-fluid {
    max-width: 100%;
    height: auto;
    display: block;
  }
</style>

<div class="container mt-4">
    <h3 class="display-4">Editar Pagamento</h3>
    <div class="card mb-4">
        <div class="card-body">

            <!-- Form principal -->
            <form method="post" action="{% url 'formacompanhamento:registro_pagamento_update' form.instance.pk %}" enctype="multipart/form-data">
                {% csrf_token %}

                <div class="container mt-4">
                    <h3 class="text-white">
                      {% if form.instance.pk %}Editar Pagamento{% else %}Novo Acionamento{% endif %}
                    </h3>

                    <div class="card mb-4">
                      <div class="card-body">

                          <!-- CAMPOS CLIENTE E PRESTADOR -->
                          {% if form.tipo_servicos.value %}
                          <h4 class="mt-2">Tipo de Serviço</h4>
                          <div class="row mb-3">
                            <div class="col-md-4">
                              <label for="id_tipo_servicos" class="form-label">Tipo de Serviço</label>
                              {{ form.tipo_servicos.errors }}
                              {{ form.tipo_servicos }}
                            </div>
                          </div>
                          {% endif %}

                          <h4 class="mt-2">Dados do Cliente</h4>
                          <div class="row mb-3">
                            {% if form.cliente.value %}
                            <div class="col-md-4">
                              <label for="id_cliente" class="form-label">Cliente</label>
                              {{ form.cliente.errors }}
                              {{ form.cliente }}
                            </div>
                            {% endif %}
                            {% if form.protocolo.value %}
                            <div class="col-md-4">
                              <label for="id_protocolo" class="form-label">Protocolo</label>
                              {{ form.protocolo }}
                            </div>
                            {% endif %}
                            {% if form.endereco.value %}
                            <div class="col-md-4">
                              <label for="id_endereco" class="form-label">Endereço</label>
                              {{ form.endereco }}
                              <!-- Botão para visualizar mapa em uma nova aba (rota customizada) -->
                              <button type="button" class="btn btn-info mt-2" onclick="openMap()">Ver Mapa</button>
                            </div>
                            {% endif %}
                          </div>

                          <div>
                            <hr>
                            <h3>Dados do Veiculo</h3>

                            <!-- Primeira linha: Marca/Modelo, Ano, Cor -->
                            <div class="row mb-3">
                              {% if form.modelo.value %}
                              <div class="col-md-3">
                                <label for="id_modelo" class="form-label">Marca / Modelo</label>
                                {{ form.modelo }}
                              </div>
                              {% endif %}
                              {% if form.ano.value %}
                              <div class="col-md-3">
                                <label for="id_ano" class="form-label">Ano Fabricação / Modelo</label>
                                {{ form.ano }}
                              </div>
                              {% endif %}
                              {% if form.cor.value %}
                              <div class="col-md-3">
                                <label for="id_cor" class="form-label">Cor</label>
                                {{ form.cor }}
                              </div>
                              {% endif %}
                            </div>

                            <!-- Botão para revelar as placas -->
                            

                            <!-- Container para as placas -->
                            <div id="placas-container" style="display: block;">
                              <div class="row mb-3">
                                <div class="col-md-4 placa-dinamica" id="placa1" style="display: block;">
                                  <label for="id_placas1" class="form-label">Placa1</label>
                                  {{ form.placas1 }}
                                </div>
                                <div class="col-md-4 placa-dinamica" id="placa2">
                                  <label for="id_placas2" class="form-label">Placa2</label>
                                  {{ form.placas2 }}
                                </div>
                                <div class="col-md-4 placa-dinamica" id="placa3">
                                  <label for="id_placas3" class="form-label">Placa3</label>
                                  {{ form.placas3 }}
                                </div>
                              </div>
                            </div>

                            <hr>

                            <!-- DADOS DO ACIONAMENTO -->
                            <h4 class="text-white">Dados do Acionamento</h4>
                            <div class="row mb-3">
                              {% if form.solicitante.value %}
                              <div class="col-md-5">
                                <label for="id_solicitante" class="form-label">Solicitante</label>
                                {{ form.solicitante }}
                              </div>
                              {% endif %}
                              {% if form.tipo_contato.value %}
                              <div class="col-md-2">
                                <label for="id_tipo_contato" class="form-label">Tipo de Contato</label>
                                {{ form.tipo_contato }}
                              </div>
                              {% endif %}
                              {% if form.motivo.value %}
                              <div class="col-md-3">
                                <label for="id_motivo" class="form-label">Motivo</label>
                                <div class="input-group">
                                  {{ form.motivo|add_class:"form-control border-danger" }}
                                </div>
                              </div>
                              {% endif %}
                              {% if form.quantidade_agentes.value %}
                              <div class="col-md-2">
                                <label for="id_quantidade_agentes" class="form-label">Quantidade de Agentes</label>
                                {{ form.quantidade_agentes }}
                              </div>
                              {% endif %}
                            </div>
                            <div class="row mb-3">
                              {% if form.prestador.value %}
                              <div class="col-md-2">
                                <label for="id_prestador" class="form-label">Prestador</label>
                                {{ form.prestador }}
                              </div>
                              {% endif %}
                              {% if form.acionamento.value %}
                              <div class="col-md-2">
                                <label for="id_acionamento" class="form-label">Valor de Acionamento</label>
                                {{ form.acionamento }}
                              </div>
                              {% endif %}
                              {% if form.franquia_hora.value %}
                              <div class="col-md-2">
                                <label for="id_franquia_hora" class="form-label">Franquia de Horas</label>
                                {{ form.franquia_hora }}
                              </div>
                              {% endif %}
                              {% if form.km_franquia.value %}
                              <div class="col-md-2">
                                <label for="id_km_franquia" class="form-label">Franquia de KM</label>
                                {{ form.km_franquia }}
                              </div>
                              {% endif %}
                              {% if form.valor_hora_excedente.value %}
                              <div class="col-md-2">
                                <label for="id_valor_hora_excedente" class="form-label">Valor de Hora Excedente</label>
                                {{ form.valor_hora_excedente }}
                              </div>
                              {% endif %}
                              {% if form.valor_km_excedente.value %}
                              <div class="col-md-2">
                                <label for="id_valor_km_excedente" class="form-label">Valor de KM Excedente</label>
                                {{ form.valor_km_excedente }}
                              </div>
                              {% endif %}
                            </div>
                            <hr>

                            <!-- DADOS DA OPERAÇÃO -->
                            <h4 class="mt-4">Dados da Operação</h4>
                            <div class="row mb-3">
                              {% if form.data_hora_inicial.value %}
                              <div class="col-md-3">
                                <label for="id_data_hora_inicial" class="form-label">Início de Operação</label>
                                <div class="input-group">
                                  {{ form.data_hora_inicial }}
                                  <button type="button" class="btn btn-primary" id="btn_inicial" onclick="registrarDataHora('id_data_hora_inicial','btn_inicial')">Registrar</button>
                                </div>
                              </div>
                              {% endif %}
                              {% if form.sla.value %}
                              <div class="col-md-1">
                                <label for="id_sla" class="form-label">SLA</label>
                                {{ form.sla }}
                              </div>
                              {% endif %}
                              {% if form.previsa_chegada.value %}
                              <div class="col-md-2">
                                <label for="id_previsa_chegada" class="form-label">Previsão de Chegada</label>
                                {{ form.previsa_chegada }}
                              </div>
                              {% endif %}

                              <div class="col-md-3">
                                <label for="id_data_hora_chegada" class="form-label">Data e Hora (Chegada)</label>
                                <div class="input-group">
                                  {{ form.data_hora_chegada }}
                                  <button type="button" class="btn btn-primary" id="btn_chegada" onclick="registrarDataHora('id_data_hora_chegada','btn_chegada')">Registrar</button>
                                </div>
                              </div>

                              <div class="col-md-3">
                                <label for="id_data_hora_final" class="form-label">Final de Operação</label>
                                <div class="input-group">
                                  {{ form.data_hora_final }}
                                  <button type="button" class="btn btn-primary" id="btn_final" onclick="registrarDataHora('id_data_hora_final','btn_final')">Registrar</button>
                                </div>
                              </div>
                            </div>
                            <div class="row mb-3">
                              <div class="col-md-2">
                                <label for="id_hora_total" class="form-label">Hora Total</label>
                                {{ form.hora_total }}
                              </div>
                              <div class="col-md-2">
                                <label for="id_km_inicial" class="form-label">Km Inicial</label>
                                {{ form.km_inicial }}
                              </div>
                              <div class="col-md-2">
                                <label for="id_km_final" class="form-label">Km Final</label>
                                {{ form.km_final }}
                              </div>
                              <div class="col-md-2">
                                <label for="id_km_total" class="form-label">KM Total</label>
                                {{ form.km_total }}
                              </div>
                              <div class="col-md-2">
                                <label for="id_km_excedente" class="form-label">KM Excedente</label>
                                {{ form.km_excedente }}
                              </div>
                              <div class="col-md-2">
                                <label for="id_hora_excedente" class="form-label">Hora Excedente</label>
                                {{ form.hora_excedente }}
                              </div>
                            </div>
                            <hr>

                            <!-- Botão de adicionar agentes -->
                            <button type="button" id="btnAdicionarAgente" class="btn btn-secondary mb-3">Adicionar Agente</button>

                            <h5>Agentes Adicionais</h5>
                            <!-- Container para agentes: somente o agente principal é exibido inicialmente -->
                            <div id="agentes-container">

 <!-- Agente principal (exibido se o campo prestador1 estiver preenchido) -->
<div class="agente-dinamico" id="agente1"
style="{% if form.prestador1.value %}display: block;{% else %}display: none;{% endif %}">
<div class="row mb-3">
<div class="col-md-3">
 <label for="id_prestador1" class="form-label">Prestador</label>
 {{ form.prestador1|add_class:"prestador-select" }}
</div>
<div class="col-md-1">
 <label for="id_acionamento1" class="form-label">Acionamento</label>
 {{ form.acionamento1 }}
</div>
<div class="col-md-2">
 <label for="id_km_franquia1" class="form-label">Franquia de KM</label>
 {{ form.km_franquia1 }}
</div>
<div class="col-md-2">
 <label for="id_franquia_hora1" class="form-label">Franquia Hora</label>
 {{ form.franquia_hora1 }}
</div>
<div class="col-md-2">
 <label for="id_valor_hora_excedente1" class="form-label">Valor Hora Excedente</label>
 {{ form.valor_hora_excedente1 }}
</div>
<div class="col-md-2">
 <label for="id_hora_excedente1" class="form-label">Hora Excedente</label>
 {{ form.hora_excedente1 }}
</div>
</div>
<div class="row mb-3">
<div class="col-md-4">
 <label for="id_data_hora_inicial1" class="form-label">Início de Operação 1</label>
 <div class="input-group">
   {{ form.data_hora_inicial1 }}
   <button type="button" class="btn btn-primary" id="btn_inicial1" onclick="registrarDataHora('id_data_hora_inicial1','btn_inicial1')">Registrar</button>
 </div>
</div>
<div class="col-md-4">
 <label for="id_data_hora_chegada1" class="form-label">Data e Hora (Chegada) 1</label>
 <div class="input-group">
   {{ form.data_hora_chegada1 }}
   <button type="button" class="btn btn-primary" id="btn_chegada1" onclick="registrarDataHora('id_data_hora_chegada1','btn_chegada1')">Registrar</button>
 </div>
</div>
<div class="col-md-4">
 <label for="id_data_hora_final1" class="form-label">Final de Operação 1</label>
 <div class="input-group">
   {{ form.data_hora_final1 }}
   <button type="button" class="btn btn-primary" id="btn_final1" onclick="registrarDataHora('id_data_hora_final1','btn_final1')">Registrar</button>
 </div>
</div>
</div>
<div class="row mb-3">
<div class="col-md-4">
 <label for="id_km_inicial1" class="form-label">Km Inicial 1</label>
 {{ form.km_inicial1 }}
</div>
<div class="col-md-4">
 <label for="id_km_final1" class="form-label">Km Final 1</label>
 {{ form.km_final1 }}
</div>
<div class="col-md-4">
 <label for="id_km_total1" class="form-label">KM Total 1</label>
 {{ form.km_total1 }}
</div>
</div>
<div class="row mb-3">
<div class="col-md-2">
 <label for="id_km_excedente1" class="form-label">KM Excedente 1</label>
 {{ form.km_excedente1 }}
</div>
<div class="col-md-2">
 <label for="id_valor_total_km_excedente1" class="form-label">Valor KM Excedente 1</label>
 {{ form.valor_km_excedente1 }}
</div>
<div class="col-md-2">
 <label for="id_hora_total1" class="form-label">Hora Total 1</label>
 <input type="text" name="hora_total1" id="id_hora_total1" class="form-control" placeholder="Hora Total" readonly>
</div>
<div class="col-md-2">
 <label for="id_motivo1" class="form-label">Motivo</label>
 <div class="input-group">
   {{ form.motivo1|add_class:"form-control border-danger" }}
 </div>
</div>
</div>
</div>

<!-- Agente adicional 2 (exibido se o campo prestador2 estiver preenchido) -->
<div class="agente-dinamico" id="agente2"
style="{% if form.prestador2.value %}display: block;{% else %}display: none;{% endif %}">
<hr>
<div class="row mb-3">
<div class="col-md-3">
 <label for="id_prestador2" class="form-label">Prestador</label>
 {{ form.prestador2|add_class:"prestador-select" }}
</div>
<div class="col-md-1">
 <label for="id_acionamento2" class="form-label">Acionamento</label>
 {{ form.acionamento2 }}
</div>
<div class="col-md-2">
 <label for="id_km_franquia2" class="form-label">Franquia de KM</label>
 {{ form.km_franquia2 }}
</div>
<div class="col-md-2">
 <label for="id_franquia_hora2" class="form-label">Franquia Hora</label>
 {{ form.franquia_hora2 }}
</div>
<div class="col-md-2">
 <label for="id_valor_hora_excedente2" class="form-label">Valor Hora Excedente</label>
 {{ form.valor_hora_excedente2 }}
</div>
<div class="col-md-2">
 <label for="id_hora_excedente2" class="form-label">Hora Excedente</label>
 {{ form.hora_excedente2 }}
</div>
</div>
<div class="row mb-3">
<div class="col-md-4">
 <label for="id_data_hora_inicial2" class="form-label">Início de Operação 2</label>
 <div class="input-group">
   {{ form.data_hora_inicial2 }}
   <button type="button" class="btn btn-primary" id="btn_inicial2" onclick="registrarDataHora('id_data_hora_inicial2','btn_inicial2')">Registrar</button>
 </div>
</div>
<div class="col-md-4">
 <label for="id_data_hora_chegada2" class="form-label">Data e Hora (Chegada) 2</label>
 <div class="input-group">
   {{ form.data_hora_chegada2 }}
   <button type="button" class="btn btn-primary" id="btn_chegada2" onclick="registrarDataHora('id_data_hora_chegada2','btn_chegada2')">Registrar</button>
 </div>
</div>
<div class="col-md-4">
 <label for="id_data_hora_final2" class="form-label">Final de Operação 2</label>
 <div class="input-group">
   {{ form.data_hora_final2 }}
   <button type="button" class="btn btn-primary" id="btn_final2" onclick="registrarDataHora('id_data_hora_final2','btn_final2')">Registrar</button>
 </div>
</div>
</div>
<div class="row mb-3">
<div class="col-md-4">
 <label for="id_km_inicial2" class="form-label">Km Inicial 2</label>
 {{ form.km_inicial2 }}
</div>
<div class="col-md-4">
 <label for="id_km_final2" class="form-label">Km Final 2</label>
 {{ form.km_final2 }}
</div>
<div class="col-md-4">
 <label for="id_km_total2" class="form-label">KM Total 2</label>
 {{ form.km_total2 }}
</div>
</div>
<div class="row mb-3">
<div class="col-md-3">
 <label for="id_km_excedente2" class="form-label">KM Excedente 2</label>
 {{ form.km_excedente2 }}
</div>
<div class="col-md-3">
 <label for="id_valor_total_km_excedente2" class="form-label">Valor KM Excedente 2</label>
 {{ form.valor_km_excedente2 }}
</div>
<div class="col-md-3">
 <label for="id_hora_total2" class="form-label">Hora Total 2</label>
 <input type="text" name="hora_total2" id="id_hora_total2" class="form-control" placeholder="Hora Total" readonly>
</div>
<div class="col-md-3">
 <label for="id_motivo2" class="form-label">Motivo</label>
 <div class="input-group">
   {{ form.motivo2|add_class:"form-control border-danger" }}
 </div>
</div>
</div>
</div>

<!-- Agente adicional 3 (exibido se o campo prestador3 estiver preenchido) -->
<div class="agente-dinamico" id="agente3"
style="{% if form.prestador3.value %}display: block;{% else %}display: none;{% endif %}">
<hr>
<div class="row mb-3">
<div class="col-md-3">
 <label for="id_prestador3" class="form-label">Prestador</label>
 {{ form.prestador3|add_class:"prestador-select" }}
</div>
<div class="col-md-1">
 <label for="id_acionamento3" class="form-label">Acionamento</label>
 {{ form.acionamento3 }}
</div>
<div class="col-md-2">
 <label for="id_km_franquia3" class="form-label">Franquia de KM</label>
 {{ form.km_franquia3 }}
</div>
<div class="col-md-2">
 <label for="id_franquia_hora3" class="form-label">Franquia Hora</label>
 {{ form.franquia_hora3 }}
</div>
<div class="col-md-2">
 <label for="id_valor_hora_excedente3" class="form-label">Valor Hora Excedente</label>
 {{ form.valor_hora_excedente3 }}
</div>
<div class="col-md-2">
 <label for="id_hora_excedente3" class="form-label">Hora Excedente</label>
 {{ form.hora_excedente3 }}
</div>
</div>
<div class="row mb-3">
<div class="col-md-4">
 <label for="id_data_hora_inicial3" class="form-label">Início de Operação 3</label>
 <div class="input-group">
   {{ form.data_hora_inicial3 }}
   <button type="button" class="btn btn-primary" id="btn_inicial3" onclick="registrarDataHora('id_data_hora_inicial3','btn_inicial3')">Registrar</button>
 </div>
</div>
<div class="col-md-4">
 <label for="id_data_hora_chegada3" class="form-label">Data e Hora (Chegada) 3</label>
 <div class="input-group">
   {{ form.data_hora_chegada3 }}
   <button type="button" class="btn btn-primary" id="btn_chegada3" onclick="registrarDataHora('id_data_hora_chegada3','btn_chegada3')">Registrar</button>
 </div>
</div>
<div class="col-md-4">
 <label for="id_data_hora_final3" class="form-label">Final de Operação 3</label>
 <div class="input-group">
   {{ form.data_hora_final3 }}
   <button type="button" class="btn btn-primary" id="btn_final3" onclick="registrarDataHora('id_data_hora_final3','btn_final3')">Registrar</button>
 </div>
</div>
</div>
<div class="row mb-3">
<div class="col-md-4">
 <label for="id_km_inicial3" class="form-label">Km Inicial 3</label>
 {{ form.km_inicial3 }}
</div>
<div class="col-md-4">
 <label for="id_km_final3" class="form-label">Km Final 3</label>
 {{ form.km_final3 }}
</div>
<div class="col-md-4">
 <label for="id_km_total3" class="form-label">KM Total 3</label>
 {{ form.km_total3 }}
</div>
</div>
<div class="row mb-3">
<div class="col-md-3">
 <label for="id_km_excedente3" class="form-label">KM Excedente 3</label>
 {{ form.km_excedente3 }}
</div>
<div class="col-md-3">
 <label for="id_valor_total_km_excedente3" class="form-label">Valor KM Excedente 3</label>
 {{ form.valor_km_excedente3 }}
</div>
<div class="col-md-3">
 <label for="id_hora_total3" class="form-label">Hora Total 3</label>
 <input type="text" name="hora_total3" id="id_hora_total3" class="form-control" placeholder="Hora Total" readonly>
</div>
<div class="col-md-3">
 <label for="id_motivo3" class="form-label">Motivo</label>
 <div class="input-group">
   {{ form.motivo3|add_class:"form-control border-danger" }}
 </div>
</div>
</div>
</div>


                            <!-- DADOS GERAIS E IMAGENS -->
                            <div class="row mb-3"></div>
                            <div class="row mb-3">
                              {% if form.rastreador.value %}
                              <div class="col-md-2">
                                <label for="id_rastreador" class="form-label">Rastreador</label>
                                {{ form.rastreador }}
                              </div>
                              {% endif %}
                              {% if form.id_equipamento.value %}
                              <div class="col-md-2" id="id_equipamento_field">
                                <label for="id_id_equipamento" class="form-label">ID Equipamento</label>
                                {{ form.id_equipamento }}
                              </div>
                              {% endif %}
                              {% if form.ultima_posicao.value %}
                              <div class="col-md-6" id="ultima_posicao_field">
                                <label for="id_ultima_posicao" class="form-label">Endereço da Última Posição</label>
                                {{ form.ultima_posicao }}
                              </div>
                              {% endif %}
                              {% if form.latlong.value %}
                              <div class="col-md-2" id="latlong_field">
                                <label for="id_latlong" class="form-label">Latitude - Longitude</label>
                                {{ form.latlong }}
                              </div>
                              {% endif %}
                            </div>
                            <div class="row mb-3">
                              {% if form.isca.value %}
                              <div class="col-md-2">
                                <label for="id_isca" class="form-label">Isca</label>
                                {{ form.isca }}
                              </div>
                              {% endif %}
                              {% if form.id_isca.value %}
                              <div class="col-md-2" id="id_isca_field">
                                <label for="id_id_isca" class="form-label">ID Equipamento</label>
                                {{ form.id_isca }}
                              </div>
                              {% endif %}
                              {% if form.ultima_posicao_isca.value %}
                              <div class="col-md-6" id="ultima_posicao_isca_field">
                                <label for="id_ultima_posicao_isca" class="form-label">Endereço da Última Posição</label>
                                {{ form.ultima_posicao_isca }}
                              </div>
                              {% endif %}
                              {% if form.latlong_isca.value %}
                              <div class="col-md-2" id="latlong_isca_field">
                                <label for="id_latlong_isca" class="form-label">Latitude - Longitude</label>
                                {{ form.latlong_isca }}
                              </div>
                              {% endif %}
                            </div>
                            <hr>

                            <div class="col-md-12" id="descricao">
                              <label for="{{ form.descricao.id_for_label }}" class="form-label"><h5>Descrição</h5></label>
                              {{ form.descricao|add_class:"form-control" }}
                            </div>

                            <!-- IMAGENS -->
                            <h4 class="mt-4">Imagens</h4>
                            <button type="button" id="btnAdicionarFoto" class="btn btn-secondary mb-3">Adicionar Fotos</button>

                            {% if form.imagem1 != "" %}
                            <div id="imagens-groups">
                              <!-- ==================== Grupo 1: Imagem 1 a Imagem 6 ==================== -->
                              <div class="btnAdicionarFoto" id="image-group-1" style="display: none;">
                                <div class="row row-cols-3 g-2 mb-3" style="display: flex;">
                                  <div class="col">
                                    <label for="id_imagem1" class="form-label">Imagem 1</label>
                                    {{ form.imagem1|add_class:"img-fluid" }}
                                  </div>
                                  <div class="col">
                                    <label for="id_imagem2" class="form-label">Imagem 2</label>
                                    {{ form.imagem2|add_class:"img-fluid" }}
                                  </div>
                                  <div class="col">
                                    <label for="id_imagem3" class="form-label">Imagem 3</label>
                                    {{ form.imagem3|add_class:"img-fluid" }}
                                  </div>
                                  <div class="col">
                                    <label for="id_imagem4" class="form-label">Imagem 4</label>
                                    {{ form.imagem4|add_class:"img-fluid" }}
                                  </div>
                                  <div class="col">
                                    <label for="id_imagem5" class="form-label">Imagem 5</label>
                                    {{ form.imagem5|add_class:"img-fluid" }}
                                  </div>
                                  <div class="col">
                                    <label for="id_imagem6" class="form-label">Imagem 6</label>
                                    {{ form.imagem6|add_class:"img-fluid" }}
                                  </div>
                                </div>
                              </div>

                              <!-- ==================== Grupo 2: Imagem 7 a Imagem 12 ==================== -->
                              <div class="btnAdicionarFoto" id="image-group-2" style="display: none;">
                                <div class="row row-cols-3 g-2 mb-3" style="display: flex;">
                                  <div class="col">
                                    <label for="id_imagem7" class="form-label">Imagem 7</label>
                                    {{ form.imagem7|add_class:"img-fluid" }}
                                  </div>
                                  <div class="col">
                                    <label for="id_imagem8" class="form-label">Imagem 8</label>
                                    {{ form.imagem8|add_class:"img-fluid" }}
                                  </div>
                                  <div class="col">
                                    <label for="id_imagem9" class="form-label">Imagem 9</label>
                                    {{ form.imagem9|add_class:"img-fluid" }}
                                  </div>
                                  <div class="col">
                                    <label for="id_imagem10" class="form-label">Imagem 10</label>
                                    {{ form.imagem10|add_class:"img-fluid" }}
                                  </div>
                                  <div class="col">
                                    <label for="id_imagem11" class="form-label">Imagem 11</label>
                                    {{ form.imagem11|add_class:"img-fluid" }}
                                  </div>
                                  <div class="col">
                                    <label for="id_imagem12" class="form-label">Imagem 12</label>
                                    {{ form.imagem12|add_class:"img-fluid" }}
                                  </div>
                                </div>
                              </div>

                              <!-- ==================== Grupo 3: Imagem 13 a Imagem 18 ==================== -->
                              <div class="btnAdicionarFoto" id="image-group-3" style="display: none;">
                                <div class="row row-cols-3 g-2 mb-3" style="display: flex;">
                                  <div class="col">
                                    <label for="id_imagem13" class="form-label">Imagem 13</label>
                                    {{ form.imagem13|add_class:"img-fluid" }}
                                  </div>
                                  <div class="col">
                                    <label for="id_imagem14" class="form-label">Imagem 14</label>
                                    {{ form.imagem14|add_class:"img-fluid" }}
                                  </div>
                                  <div class="col">
                                    <label for="id_imagem15" class="form-label">Imagem 15</label>
                                    {{ form.imagem15|add_class:"img-fluid" }}
                                  </div>
                                  <div class="col">
                                    <label for="id_imagem16" class="form-label">Imagem 16</label>
                                    {{ form.imagem16|add_class:"img-fluid" }}
                                  </div>
                                  <div class="col">
                                    <label for="id_imagem17" class="form-label">Imagem 17</label>
                                    {{ form.imagem17|add_class:"img-fluid" }}
                                  </div>
                                  <div class="col">
                                    <label for="id_imagem18" class="form-label">Imagem 18</label>
                                    {{ form.imagem18|add_class:"img-fluid" }}
                                  </div>
                                </div>
                              </div>

                              <!-- ==================== Grupo 4: Imagem 19 a Imagem 24 ==================== -->
                              <div class="btnAdicionarFoto" id="image-group-4" style="display: none;">
                                <div class="row row-cols-3 g-2 mb-3" style="display: flex;">
                                  <div class="col">
                                    <label for="id_imagem19" class="form-label">Imagem 19</label>
                                    {{ form.imagem19|add_class:"img-fluid" }}
                                  </div>
                                  <div class="col">
                                    <label for="id_imagem20" class="form-label">Imagem 20</label>
                                    {{ form.imagem20|add_class:"img-fluid" }}
                                  </div>
                                  <div class="col">
                                    <label for="id_imagem21" class="form-label">Imagem 21</label>
                                    {{ form.imagem21|add_class:"img-fluid" }}
                                  </div>
                                  <div class="col">
                                    <label for="id_imagem22" class="form-label">Imagem 22</label>
                                    {{ form.imagem22|add_class:"img-fluid" }}
                                  </div>
                                  <div class="col">
                                    <label for="id_imagem23" class="form-label">Imagem 23</label>
                                    {{ form.imagem23|add_class:"img-fluid" }}
                                  </div>
                                  <div class="col">
                                    <label for="id_imagem24" class="form-label">Imagem 24</label>
                                    {{ form.imagem24|add_class:"img-fluid" }}
                                  </div>
                                </div>
                              </div>

                              <!-- ==================== Grupo 5: Imagem 25 a Imagem 30 ==================== -->
                              <div class="btnAdicionarFoto" id="image-group-5" style="display: none;">
                                <div class="row row-cols-3 g-2 mb-3" style="display: flex;">
                                  <div class="col">
                                    <label for="id_imagem25" class="form-label">Imagem 25</label>
                                    {{ form.imagem25|add_class:"img-fluid" }}
                                  </div>
                                  <div class="col">
                                    <label for="id_imagem26" class="form-label">Imagem 26</label>
                                    {{ form.imagem26|add_class:"img-fluid" }}
                                  </div>
                                  <div class="col">
                                    <label for="id_imagem27" class="form-label">Imagem 27</label>
                                    {{ form.imagem27|add_class:"img-fluid" }}
                                  </div>
                                  <div class="col">
                                    <label for="id_imagem28" class="form-label">Imagem 28</label>
                                    {{ form.imagem28|add_class:"img-fluid" }}
                                  </div>
                                  <div class="col">
                                    <label for="id_imagem29" class="form-label">Imagem 29</label>
                                    {{ form.imagem29|add_class:"img-fluid" }}
                                  </div>
                                  <div class="col">
                                    <label for="id_imagem30" class="form-label">Imagem 30</label>
                                    {{ form.imagem30|add_class:"img-fluid" }}
                                  </div>
                                </div>
                              </div>

                              <!-- ==================== Grupo 6: Imagem 31 a Imagem 36 ==================== -->
                              <div class="btnAdicionarFoto" id="image-group-6" style="display: none;">
                                <div class="row row-cols-3 g-2 mb-3" style="display: flex;">
                                  <div class="col">
                                    <label for="id_imagem31" class="form-label">Imagem 31</label>
                                    {{ form.imagem31|add_class:"img-fluid" }}
                                  </div>
                                  <div class="col">
                                    <label for="id_imagem32" class="form-label">Imagem 32</label>
                                    {{ form.imagem32|add_class:"img-fluid" }}
                                  </div>
                                  <div class="col">
                                    <label for="id_imagem33" class="form-label">Imagem 33</label>
                                    {{ form.imagem33|add_class:"img-fluid" }}
                                  </div>
                                  <div class="col">
                                    <label for="id_imagem34" class="form-label">Imagem 34</label>
                                    {{ form.imagem34|add_class:"img-fluid" }}
                                  </div>
                                  <div class="col">
                                    <label for="id_imagem35" class="form-label">Imagem 35</label>
                                    {{ form.imagem35|add_class:"img-fluid" }}
                                  </div>
                                  <div class="col">
                                    <label for="id_imagem36" class="form-label">Imagem 36</label>
                                    {{ form.imagem36|add_class:"img-fluid" }}
                                  </div>
                                </div>
                              </div>

                              <!-- ==================== Grupo 7: Imagem 37 a Imagem 42 ==================== -->
                              <div class="btnAdicionarFoto" id="image-group-7" style="display: none;">
                                <div class="row row-cols-3 g-2 mb-3" style="display: flex;">
                                  <div class="col">
                                    <label for="id_imagem37" class="form-label">Imagem 37</label>
                                    {{ form.imagem37|add_class:"img-fluid" }}
                                  </div>
                                  <div class="col">
                                    <label for="id_imagem38" class="form-label">Imagem 38</label>
                                    {{ form.imagem38|add_class:"img-fluid" }}
                                  </div>
                                  <div class="col">
                                    <label for="id_imagem39" class="form-label">Imagem 39</label>
                                    {{ form.imagem39|add_class:"img-fluid" }}
                                  </div>
                                  <div class="col">
                                    <label for="id_imagem40" class="form-label">Imagem 40</label>
                                    {{ form.imagem40|add_class:"img-fluid" }}
                                  </div>
                                  <div class="col">
                                    <label for="id_imagem41" class="form-label">Imagem 41</label>
                                    {{ form.imagem41|add_class:"img-fluid" }}
                                  </div>
                                  <div class="col">
                                    <label for="id_imagem42" class="form-label">Imagem 42</label>
                                    {{ form.imagem42|add_class:"img-fluid" }}
                                  </div>
                                </div>
                              </div>

                              <!-- ==================== Grupo 8: Imagem 43 a Imagem 45 ==================== -->
                              <div class="btnAdicionarFoto" id="image-group-8" style="display: none;">
                                <div class="row row-cols-3 g-2 mb-3" style="display: flex;">
                                  <div class="col">
                                    <label for="id_imagem43" class="form-label">Imagem 43</label>
                                    {{ form.imagem43|add_class:"img-fluid" }}
                                  </div>
                                  <div class="col">
                                    <label for="id_imagem44" class="form-label">Imagem 44</label>
                                    {{ form.imagem44|add_class:"img-fluid" }}
                                  </div>
                                  <div class="col">
                                    <label for="id_imagem45" class="form-label">Imagem 45</label>
                                    {{ form.imagem45|add_class:"img-fluid" }}
                                  </div>
                                </div>
                              </div>

                            </div>
                            {% endif %}

                            <!-- Botões de Submit / Cancelar -->
                            <div class="d-flex justify-content-between mt-4">
                              <button type="submit" class="btn btn-primary">Salvar</button>
                              <a href="{% url 'formacompanhamento:registro_pagamento_list' %}" class="btn btn-secondary">Cancelar e Voltar</a>
                            </div>

                      </div> <!-- /card-body -->
                    </div> <!-- /card -->
                </div> <!-- /container -->
            </form> <!-- /form principal -->
        </div>
    </div>
</div>

{% if form.errors %}
    <div class="alert alert-danger">
        <ul>
            {% for field, errors in form.errors.items %}
                <li><strong>{{ field }}</strong>: {{ errors|join:", " }}</li>
            {% endfor %}
        </ul>
    </div>
{% endif %}

<!-- Script para exibir os blocos dos agentes adicionais, placas e fotos, e realizar os cálculos -->
<script>
  
  document.addEventListener("DOMContentLoaded", function() {
    // ======================================================
    // 1) Função para registrar a data/hora atual
    function registrarDataHora(inputId, btnId) {
      var agora = new Date();
      var ano = agora.getFullYear();
      var mes = ("0" + (agora.getMonth() + 1)).slice(-2);
      var dia = ("0" + agora.getDate()).slice(-2);
      var hora = ("0" + agora.getHours()).slice(-2);
      var minutos = ("0" + agora.getMinutes()).slice(-2);
      var segundos = ("0" + agora.getSeconds()).slice(-2);
      var dataHoraFormatada = ano + "-" + mes + "-" + dia + " " + hora + ":" + minutos + ":" + segundos;

      var inputField = document.getElementById(inputId);
      if (inputField) {
        inputField.value = dataHoraFormatada;
      }

      var botao = document.getElementById(btnId);
      if (botao) {
        botao.style.display = "none";
      }

      if (inputId.indexOf("id_data_hora_inicial") === 0 || inputId.indexOf("id_data_hora_final") === 0) {
        var block = inputId.replace(/id_data_hora_(inicial|final)/, "");
        calculateHoraTotal(block);
        calculateHoraExcedente(block);
      }
    }
    window.registrarDataHora = registrarDataHora;

    // ======================================================
    // 2) Atualiza os campos do prestador via AJAX
    var lastPrestadorData = null;
    function attachPrestadorChangeListener(selectElem) {
      selectElem.addEventListener("change", function() {
        var prestadorId = this.value;
        var block = this.id.replace("id_prestador", "");
        if (prestadorId) {
          fetch("{% url 'formacompanhamento:prestador_detail' %}?id=" + prestadorId)
            .then(function(response) {
              if (!response.ok) {
                throw new Error("Erro na resposta da rede.");
              }
              return response.json();
            })
            .then(function(data) {
              if (!data.error) {
                lastPrestadorData = data;
                var acionamentoId = "id_acionamento" + block;
                if (document.getElementById(acionamentoId)) {
                  document.getElementById(acionamentoId).value = data.acionamento || "";
                }
                updateAcionamentoByMotivo(block);
                calculateHoraExcedente(block);
              }
            })
            .catch(function(error) {
              console.error("Erro ao buscar os dados do prestador:", error);
            });
        }
      });
    }
    var prestadorSelects = document.querySelectorAll(".prestador-select");
    prestadorSelects.forEach(function(selectElem) {
      attachPrestadorChangeListener(selectElem);
    });
    var mainSelect = document.getElementById("id_prestador");
    if (mainSelect && !mainSelect.classList.contains("prestador-select")) {
      attachPrestadorChangeListener(mainSelect);
    }

    // ======================================================
    // 3) Atualiza os campos de acionamento conforme o motivo selecionado
    function updateAcionamentoByMotivo(block) {
      var motivoField = document.getElementById("id_motivo" + block);
      var motivo = motivoField ? motivoField.value.trim().toLowerCase() : "";

      var acionamentoField = document.getElementById("id_acionamento" + block);
      var franquiaHoraField = document.getElementById("id_franquia_hora" + block);
      var kmFranquiaField = document.getElementById("id_km_franquia" + block);
      var valorHoraExcedenteField = document.getElementById("id_valor_hora_excedente" + block);
      var valorKmExcedenteField = document.getElementById("id_valor_km_excedente" + block);

      // Exemplos de motivos
      if (motivo === "antenista") {
        if (acionamentoField) { acionamentoField.value = lastPrestadorData.valor_antenista || ""; }
        if (franquiaHoraField) { franquiaHoraField.value = lastPrestadorData.franquia_hora_antenista || ""; }
        if (kmFranquiaField) { kmFranquiaField.value = lastPrestadorData.franquia_km_antenista || ""; }
        if (valorHoraExcedenteField) { valorHoraExcedenteField.value = lastPrestadorData.valorh_antenista || ""; }
        if (valorKmExcedenteField) { valorKmExcedenteField.value = lastPrestadorData.valorkm_antenista || ""; }
      } else if (motivo === "pronta resposta armado") {
        if (acionamentoField) { acionamentoField.value = lastPrestadorData.valor_prontaresposta_armado || ""; }
        if (franquiaHoraField) { franquiaHoraField.value = lastPrestadorData.franquia_hora_armado || ""; }
        if (kmFranquiaField) { kmFranquiaField.value = lastPrestadorData.franquia_km_armado || ""; }
        if (valorHoraExcedenteField) { valorHoraExcedenteField.value = lastPrestadorData.valorh_armado || ""; }
        if (valorKmExcedenteField) { valorKmExcedenteField.value = lastPrestadorData.valorkm_armado || ""; }
      } else if (motivo === "pronta resposta desarmado") {
        if (acionamentoField) { acionamentoField.value = lastPrestadorData.valor_prontaresposta_desarmado || ""; }
        if (franquiaHoraField) { franquiaHoraField.value = lastPrestadorData.franquia_hora_desarmado || ""; }
        if (kmFranquiaField) { kmFranquiaField.value = lastPrestadorData.franquia_km_desarmado || ""; }
        if (valorHoraExcedenteField) { valorHoraExcedenteField.value = lastPrestadorData.valorh_desarmado || ""; }
        if (valorKmExcedenteField) { valorKmExcedenteField.value = lastPrestadorData.valorkm_desarmado || ""; }
      } else {
        if (acionamentoField) { acionamentoField.value = lastPrestadorData.acionamento || ""; }
      }
    }
    if (document.getElementById("id_motivo")) {
      document.getElementById("id_motivo").addEventListener("change", function() {
        updateAcionamentoByMotivo("");
      });
    }
    var motivosAdicionais = document.querySelectorAll("[id^='id_motivo']");
    motivosAdicionais.forEach(function(elem) {
      if (elem.id !== "id_motivo") {
        var block = elem.id.replace("id_motivo", "");
        elem.addEventListener("change", function() {
          updateAcionamentoByMotivo(block);
        });
      }
    });

    let currentGroupIndex = 0;
    
    function showMoreImages() {
      // Seleciona todas as divs que têm a classe .image-group
      const groups = document.querySelectorAll('.image-group');
      // Se ainda houver grupo para mostrar
      if (currentGroupIndex < groups.length) {
        groups[currentGroupIndex].style.display = 'flex'; 
        currentGroupIndex++;
      }
    }
    // AQUI:
    window.showMoreImages = showMoreImages;

    // ======================================================
    // 4) Exibe/oculta campos conforme seleção
    function toggleFieldVisibility(selectId, fieldIds, expectedValue="sim") {
      var selectElem = document.getElementById(selectId);
      if (!selectElem) return;
      function updateVisibility() {
        var valor = selectElem.value.toLowerCase();
        fieldIds.forEach(function(fieldId) {
          var fieldElem = document.getElementById(fieldId);
          if (fieldElem) {
            fieldElem.style.display = (valor === expectedValue.toLowerCase()) ? "block" : "none";
          }
        });
      }
      updateVisibility();
      selectElem.addEventListener("change", updateVisibility);
    }
    toggleFieldVisibility("id_rastreador", ["id_equipamento_field", "ultima_posicao_field", "latlong_field"], "sim");
    toggleFieldVisibility("id_isca", ["id_isca_field", "ultima_posicao_isca_field", "latlong_isca_field"], "sim");

    // ======================================================
    // 5) Calcula a previsão de chegada
    function formatDateTime(dateObj) {
      var ano = dateObj.getFullYear();
      var mes = ("0" + (dateObj.getMonth() + 1)).slice(-2);
      var dia = ("0" + dateObj.getDate()).slice(-2);
      var hora = ("0" + dateObj.getHours()).slice(-2);
      var minutos = ("0" + dateObj.getMinutes()).slice(-2);
      var segundos = ("0" + dateObj.getSeconds()).slice(-2);
      return ano + "-" + mes + "-" + dia + " " + hora + ":" + minutos + ":" + segundos;
    }
    function calculatePrevisaoChegada() {
      var slaElem = document.getElementById("id_sla");
      var inicioElem = document.getElementById("id_data_hora_inicial");
      var previsaoElem = document.getElementById("id_previsa_chegada");
      if (slaElem && inicioElem && previsaoElem) {
        var slaValue = parseFloat(slaElem.value);
        var inicioStr = inicioElem.value;
        if (!isNaN(slaValue) && inicioStr) {
          var inicioISO = inicioStr.indexOf("T") === -1 ? inicioStr.replace(" ", "T") : inicioStr;
          var inicioDate = new Date(inicioISO);
          if (!isNaN(inicioDate.getTime())) {
            var previsaoDate = new Date(inicioDate.getTime() + slaValue * 60000);
            previsaoElem.value = formatDateTime(previsaoDate);
          }
        }
      }
    }
    if (document.getElementById("id_sla")) {
      document.getElementById("id_sla").addEventListener("input", calculatePrevisaoChegada);
      document.getElementById("id_sla").addEventListener("change", calculatePrevisaoChegada);
    }
    if (document.getElementById("id_data_hora_inicial")) {
      document.getElementById("id_data_hora_inicial").addEventListener("change", calculatePrevisaoChegada);
      document.getElementById("id_data_hora_inicial").addEventListener("blur", calculatePrevisaoChegada);
    }

    // ======================================================
    // 6) Calcula a Hora Total
    function parseDateTimeGeneric(dateTimeStr) {
      if (!dateTimeStr) return NaN;
      var isoStr = dateTimeStr.indexOf("T") === -1 ? dateTimeStr.replace(" ", "T") : dateTimeStr;
      return new Date(isoStr);
    }
    function calculateHoraTotal(block) {
      var inicioId = "id_data_hora_inicial" + block;
      var finalId = "id_data_hora_final" + block;
      var totalId = "id_hora_total" + block;
      var inicioElem = document.getElementById(inicioId);
      var finalElem = document.getElementById(finalId);
      var totalElem = document.getElementById(totalId);
      if (inicioElem && finalElem && totalElem) {
        var inicioStr = inicioElem.value.trim();
        var finalStr = finalElem.value.trim();
        if (inicioStr && finalStr) {
          var inicioDate = parseDateTimeGeneric(inicioStr);
          var finalDate = parseDateTimeGeneric(finalStr);
          if (isNaN(inicioDate.getTime()) || isNaN(finalDate.getTime()) || finalDate < inicioDate) {
            totalElem.value = "";
            return;
          }
          var diffMs = finalDate - inicioDate;
          var diffMinutes = Math.floor(diffMs / 60000);
          var hours = Math.floor(diffMinutes / 60);
          var minutes = diffMinutes % 60;
          totalElem.value = hours + "." + (minutes < 10 ? "0" + minutes : minutes);
        } else {
          totalElem.value = "";
        }
      }
    }
    function attachHoraTotalCalculation(block) {
      var inicioId = "id_data_hora_inicial" + block;
      var finalId = "id_data_hora_final" + block;
      var inicioElem = document.getElementById(inicioId);
      var finalElem = document.getElementById(finalId);
      if (inicioElem) {
        inicioElem.addEventListener("change", function() {
          calculateHoraTotal(block);
          calculateHoraExcedente(block);
        });
        inicioElem.addEventListener("blur", function() {
          calculateHoraTotal(block);
          calculateHoraExcedente(block);
        });
      }
      if (finalElem) {
        finalElem.addEventListener("change", function() {
          calculateHoraTotal(block);
          calculateHoraExcedente(block);
        });
        finalElem.addEventListener("blur", function() {
          calculateHoraTotal(block);
          calculateHoraExcedente(block);
        });
      }
      var franquiaElem = document.getElementById("id_franquia_hora" + block);
      if (franquiaElem) {
        franquiaElem.addEventListener("change", function() {
          calculateHoraExcedente(block);
        });
        franquiaElem.addEventListener("blur", function() {
          calculateHoraExcedente(block);
        });
      }
    }
    attachHoraTotalCalculation("");
    attachHoraTotalCalculation("1");
    attachHoraTotalCalculation("2");
    attachHoraTotalCalculation("3");

    // ======================================================
    // 7) Calcula a Hora Excedente
    function calculateHoraExcedente(block) {
      var inicioId = "id_data_hora_inicial" + block;
      var finalId = "id_data_hora_final" + block;
      var franquiaId = "id_franquia_hora" + block;
      var excedenteId = "id_hora_excedente" + block;
      var inicioElem = document.getElementById(inicioId);
      var finalElem = document.getElementById(finalId);
      var franquiaElem = document.getElementById(franquiaId);
      var excedenteElem = document.getElementById(excedenteId);
      if (inicioElem && finalElem && franquiaElem && excedenteElem) {
        var inicioStr = inicioElem.value.trim();
        var finalStr = finalElem.value.trim();
        if (inicioStr && finalStr) {
          var inicioDate = parseDateTimeGeneric(inicioStr);
          var finalDate = parseDateTimeGeneric(finalStr);
          if (isNaN(inicioDate.getTime()) || isNaN(finalDate.getTime()) || finalDate < inicioDate) {
            excedenteElem.value = "";
            return;
          }
          var diffMs = finalDate - inicioDate;
          var diffMinutes = Math.floor(diffMs / 60000);
          var franquia = parseFloat(franquiaElem.value);
          if (isNaN(franquia)) { franquia = 0; }
          var franquiaMinutes = franquia * 60;
          var excedenteMinutes = diffMinutes - franquiaMinutes;
          if (excedenteMinutes < 0) { excedenteMinutes = 0; }
          var hoursEx = Math.floor(excedenteMinutes / 60);
          var minutesEx = excedenteMinutes % 60;
          excedenteElem.value = hoursEx + "." + (minutesEx < 10 ? "0" + minutesEx : minutesEx);
        } else {
          excedenteElem.value = "";
        }
      }
    }

    // ======================================================
    // 8) Calcula o KM Total e o KM Excedente
    function calculateKmTotal(block) {
      var kmInicialElem = document.getElementById("id_km_inicial" + block);
      var kmFinalElem = document.getElementById("id_km_final" + block);
      var kmTotalElem = document.getElementById("id_km_total" + block);
      var kmFranquiaElem = document.getElementById("id_km_franquia" + block);
      var kmExcedenteElem = document.getElementById("id_km_excedente" + block);
      if (kmInicialElem && kmFinalElem && kmTotalElem) {
        var kmInicial = parseFloat(kmInicialElem.value);
        var kmFinal = parseFloat(kmFinalElem.value);
        if (isNaN(kmInicial) || isNaN(kmFinal)) {
          kmTotalElem.value = "";
          if (kmExcedenteElem) { kmExcedenteElem.value = ""; }
          return;
        }
        var kmTotal = kmFinal - kmInicial;
        kmTotalElem.value = kmTotal;
        if (kmFranquiaElem && kmExcedenteElem) {
          var kmFranquia = parseFloat(kmFranquiaElem.value);
          if (!isNaN(kmFranquia)) {
            kmExcedenteElem.value = kmTotal - kmFranquia;
          } else {
            kmExcedenteElem.value = "";
          }
        }
      }
    }
    function attachKmCalculation(block) {
      var kmInicialElem = document.getElementById("id_km_inicial" + block);
      var kmFinalElem = document.getElementById("id_km_final" + block);
      var kmFranquiaElem = document.getElementById("id_km_franquia" + block);
      if (kmInicialElem) {
        kmInicialElem.addEventListener("change", function() { calculateKmTotal(block); });
        kmInicialElem.addEventListener("blur", function() { calculateKmTotal(block); });
      }
      if (kmFinalElem) {
        kmFinalElem.addEventListener("change", function() { calculateKmTotal(block); });
        kmFinalElem.addEventListener("blur", function() { calculateKmTotal(block); });
      }
      if (kmFranquiaElem) {
        kmFranquiaElem.addEventListener("change", function() { calculateKmTotal(block); });
        kmFranquiaElem.addEventListener("blur", function() { calculateKmTotal(block); });
      }
    }
    attachKmCalculation("");
    attachKmCalculation("1");
    attachKmCalculation("2");
    attachKmCalculation("3");

    // ================================================
    // 9. Exibir blocos agentes adicionais (mantido)
    var btnAdicionarAgente = document.getElementById("btnAdicionarAgente");
    if (btnAdicionarAgente) {
        btnAdicionarAgente.addEventListener("click", function() {
            var agentes = document.querySelectorAll(".agente-dinamico");
            for (var i = 0; i < agentes.length; i++) {
                if (agentes[i].style.display === "none") {
                    agentes[i].style.display = "block";
                    break; // Exibe apenas um bloco por clique
                }
            }
        });
    }

    // ================================================
    // 10. Exibir grupos de fotos dinamicamente (ajustado para 'style="display:none;"')
    var btnAdicionarFoto = document.getElementById("btnAdicionarFoto");
    if (btnAdicionarFoto) {
        var currentGroup = 1; // Controla qual grupo será exibido
        btnAdicionarFoto.addEventListener("click", function() {
            var imageGroups = document.querySelectorAll("[id^='image-group-']");
            
            // Verifica se há grupos disponíveis para exibir
            if (currentGroup <= imageGroups.length) {
                // Exibe o próximo grupo
                var currentImageGroup = imageGroups[currentGroup - 1];
                currentImageGroup.style.display = "flex"; 
                currentGroup++; // Avança para o próximo grupo
            }

            // Se todos os grupos forem exibidos, desativa o botão
            if (currentGroup > imageGroups.length) {
                btnAdicionarFoto.style.display = "none";
            }
        });
    }
    
    function toggleVisibility(id) {
        var element = document.getElementById(id);
        if (element.style.display === "none" || element.style.display === "") {
            element.style.display = "block";
        } else {
            element.style.display = "none";
        }
    }
});
</script>

{% endblock %}
